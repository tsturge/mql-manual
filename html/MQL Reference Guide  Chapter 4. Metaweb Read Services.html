
<!-- saved from url=(0032)http://mql.freebaseapps.com/ch04 -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>
        MQL Reference Guide: 
  Chapter 4. Metaweb Read Services
      </title>
      <link href="./MQL Reference Guide  Chapter 4. Metaweb Read Services_files/stylesheet.css" rel="stylesheet" type="text/css">
              
  
  <link href="http://mql.freebaseapps.com/index" rel="home" title="Table of Contents">
  <link href="http://mql.freebaseapps.com/index" rel="up" title="Table of Contents">
  <link href="http://mql.freebaseapps.com/ch03" rel="prev" title="Chapter 3. The Metaweb Query Language">
  <link href="http://mql.freebaseapps.com/ch05" rel="next" title="Chapter 5. The MQL Write Grammar">
    </head>
    <body>
      
  <div id="header">
    <div id="nav">
      Chapter 4. Metaweb Read Services        
      
      <a href="http://mql.freebaseapps.com/ch03">◁ previous</a> 
      <a href="http://mql.freebaseapps.com/index">△ contents</a> 
      <a href="http://mql.freebaseapps.com/ch05">next ▷</a>
    </div>
    
    <div id="logo">
      <a href="http://mql.freebaseapps.com/index" title="MQL Reference Guide contents"><img alt="MQL Reference Guide" border="0" height="18" width="258" src="./MQL Reference Guide  Chapter 4. Metaweb Read Services_files/logo-mqlreference.png"></a>
    </div>
  </div>
      
    <div class="chapter" lang="en" xml:lang="en">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title">
              <a id="mqlread" name="mqlread"></a>Chapter 4. Metaweb Read Services
            </h2>
          </div>
        </div>
      </div>
      <p>
        <a class="xref" href="http://mql.freebaseapps.com/ch03.html" title="Chapter 3. The Metaweb Query Language">Chapter 3</a> explained how to express Metaweb queries using MQL. This chapter explains how to deliver those queries to Metaweb servers and retrieve their response using the <span class="emphasis"><em>mqlread</em></span> service. It also explains how to search Metaweb with the <span class="emphasis"><em>search</em></span> service and how to retrieve chunks of data (such as images and HTML documents) using the <span class="emphasis"><em>trans</em></span> service. The chapter includes example applications and libraries written in Perl, Python, PHP, and JavaScript and concludes with a sophisticated Python library for interacting with Metaweb's read services.
      </p>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="simpleperlqueries" name="simpleperlqueries"></a>4.1. Basic mqlread Queries with Perl
              </h2>
            </div>
          </div>
        </div>
        <p>
          Metaweb's services are all implemented on top of the HTTP protocol. Submitting a MQL query and retrieving the response, therefore, is simply a matter of constructing the appropriate URL and fetching its content via an HTTP request.
        </p>
        <p>
          The basic URL for submitting MQL queries to <span class="emphasis"><em>freebase.com</em></span> is:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/service/mqlread
</pre>
        <p>
          To submit a query to the <span class="emphasis"><em>mqlread</em></span> service, follow these steps:
        </p>
        <div class="itemizedlist">
          <ul>
            <li>
              <p>
                Place the query inside an "envelope" object.
              </p>
            </li>
            <li>
              <p>
                Serialize the envelope object to a JSON string.
              </p>
            </li>
            <li>
              <p>
                Escape punctuation characters in the JSON string using standard URL encoding.
              </p>
            </li>
            <li>
              <p>
                Concatenate the basic URL above with "?query=" and the escaped and encoded JSON string to form a complete mqlread URL.
              </p>
            </li>
            <li>
              <p>
                Fetch the contents of the URL with an HTTP GET request.
              </p>
            </li>
          </ul>
        </div>
        <p>
          <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.pl" title="Example 4.1. albumlist.pl: submitting MQL queries in Perl">Example 4.1</a> is a command-line utility that lists the albums released by any band you specify. It uses the Metaweb API to retrieve data from <span class="emphasis"><em>freebase.com</em></span>. It is written in Perl, and demonstrates how to nest an MQL query within an envelope and send that envelope to to the <span class="emphasis"><em>mqlread</em></span> service. (The structure of the envelope object will be explained in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#queryparam" title="4.2.1. The query Request Parameter">Section 4.2.1</a>.)
        </p>
        <div class="example">
          <a id="albumlist.pl" name="albumlist.pl"></a>
          <p class="title">
            <b>Example 4.1. albumlist.pl: submitting MQL queries in Perl</b>
          </p>
          <div class="example-contents">
            <pre class="programlisting">#!/usr/bin/perl
use URI::Escape;  # This module provides the uri_escape function used below.

# Build the Metaweb query, using string manipulation.
# CAUTION: the use of string manipulation here makes this script vulnerable
# to MQL injection attacks when the command-line argument includes JSON.
$band = $ARGV[0]; # This is the band or musician whose albums are to be listed
$query='{"type":"/music/artist","name":"' . $band . '","album":[]}';

# Now place the query in a JSON envelope, and URL encode the envelope.
$envelope = '{"query":' . $query . '}';
$escaped = uri_escape($envelope); 

# Construct the URL that represents the query.
$baseurl='http://api.freebase.com/api/service/mqlread'; # Base URL for queries
$url = $baseurl . "?query=" . $escaped;

# Use the command-line utility curl to fetch the content of the URL.
$result = `curl -s $url`;

# Use regular expressions to extract the album list from the HTTP response.
$result =~ s/^.*"album"\s*:\s*\[\s*([^\]]*)\].*$/$1/s;
$result =~ s/[ \t]*"[ \t,]*//g;

# Finally, display the list of albums.
print "$result\n";
</pre>
          </div>
        </div><br class="example-break">
        <p>
          You run this program from the command line. An invocation might look like this:
        </p>
        <pre class="programlisting">$ <span class="bold"><strong>perl albumlist.pl 'Spinal Tap'</strong></span>
Break Like the Wind
This Is Spinal Tap
The Majesty of Rock
Smell the Glove
</pre>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="perlalbumexample" name="perlalbumexample"></a>4.1.1. A Better Perl Album Lister
                </h3>
              </div>
            </div>
          </div>
          <p>
            The first thing to notice about <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.pl" title="Example 4.1. albumlist.pl: submitting MQL queries in Perl">Example 4.1</a> is that it does not use a JSON serializer or parser: a JSON-encoded MQL query is constructed with string concatenation and the desired results are extracted with regular expressions. These shortcuts keep the example simple and allow us to focus on how the <span class="emphasis"><em>mqlread</em></span> URL is built and its content fetched. More sophisticated applications, however, use a JSON encoder to serialize the query and a JSON decoder to parse the result. Building queries with string manipulation can be reasonable in the simplest applications (though caution is required to avoid MQL injection attacks), but attempting to extract results with regular expressions is brittle and not a technique to emulate in your own code!
          </p>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.pl" title="Example 4.2. albumlist2.pl: a better Perl album lister">Example 4.2</a> is a higher-level version of <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.pl" title="Example 4.1. albumlist.pl: submitting MQL queries in Perl">Example 4.1</a>. It uses a JSON serializer and parser and also a higher-level API for URL manipulation. To use it, you must have the JSON.pm module (version 2 or higher) installed<sup>[<a class="footnote" href="http://mql.freebaseapps.com/ch04#ftn.id2958683" id="id2958683" name="id2958683">16</a>]</sup>. This version of the program also uses a somewhat more sophisticated query to sort albums by their release date, and also does error checking and error reporting in case anything goes wrong with the query. Finally, it also adds an additional input parameter to the query envelope to specify that HTML escaping should not be done on the query results. With this option, ampersands in album names are returned as <code class="literal">&amp;</code> rather than as <code class="literal">&amp;amp;</code>, which is what we want since this application runs in a terminal rather than in a browser.
          </p>
          <p>
            Notice that the <span class="emphasis"><em>mqlread</em></span> service returns the query results in a response envelope object that is similar to the query envelope. This response envelope has a property named <code class="literal">result</code> whose value is the result of the MQL query.
          </p>
          <div class="example">
            <a id="albumlist2.pl" name="albumlist2.pl"></a>
            <p class="title">
              <b>Example 4.2. albumlist2.pl: a better Perl album lister</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">#!/usr/bin/perl -w
use strict;           # Don't allow sloppy syntax
use JSON;             # JSON encoding and decoding with to_json and from_json
use URI::Escape;      # URI encoding with uri_escape
use LWP::UserAgent;   # High-level HTTP API

# Some constants for this script
my $SERVER = 'http://api.freebase.com';            # The Metaweb server
my $QUERYURL = $SERVER . '/api/service/mqlread';   # Path to mqlread service

# What band did the user ask about?
my $band = $ARGV[0];

# Construct a Metaweb query as a Perl data structure.
my $query =  {
    type =&gt; "/music/artist",    # We're looking for a band.
    name =&gt; $band,              # This is the name of the band.
    album =&gt; [{                 # Return some albums.
        name =&gt; undef,          # undef is Perl's null.
        sort =&gt; "release_date", # Sort by release date.
        release_date =&gt; undef   # Return release date, too.
    }]
};

# Put the query in an envelope object.
my $envelope = {        
    query =&gt; $query,             # The "query" property holds the query.
    escape =&gt; JSON::false        # Don't HTML escape result text
};                      

# Convert the envelope object from Perl hash to JSON string, and URI encode it.
my $encoded = to_json($envelope);    # Serialize object to string.
my $escaped = uri_escape($encoded);  # URI encode the string.

# Build the complete query url.
my $url = $QUERYURL . "?query=" . $escaped;

# Create the HTTP "user agent" we'll use to send the query.
my $ua = LWP::UserAgent-&gt;new;

# Send request to the server and get the response.
my $response = $ua-&gt;get($url);

# Now handle the mqlread response.
if ($response-&gt;is_success) {                      # If we get HTTP 200 OK...
    my $responsetext = $response-&gt;content;        # Get result as JSON text.
    my $response = from_json($responsetext);      # Parse text to a Perl hash.

    if ($response-&gt;{code} ne "/api/status/ok") {  # If the query was not okay:
        my $err = $response-&gt;{messages}[0];       # get the error message obj
        die $err-&gt;{code}.': '.$err-&gt;{message};    # and exit with error message
    }

    # If there was no error, the MQL result is in the response envelope
    my $result = $response-&gt;{result};   # Open response envelope, get result.
    my $albums = $result-&gt;{album};      # Get albums array from result.
    for my $album (@$albums) {          # Loop through albums.
        print "$album-&gt;{name}";         # Print the name of each.
        if ($album-&gt;{release_date}) {   # Print release date, if there is one.
            print " [" . substr($album-&gt;{release_date},0,4) . "]"; # Year only.
        }
        print "\n";                     # Add a newline.
    }
}
else {                                  # If query failed...
    die "Server returned error code " . $response-&gt;code . "\n";
}
</pre>
            </div>
          </div><br class="example-break">
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="mqlreadservice" name="mqlreadservice"></a>4.2. The mqlread Service
              </h2>
            </div>
          </div>
        </div>
        <p>
          Now that we've seen some working code, this section explains more formally how <span class="emphasis"><em>mqlread</em></span> works. Like all Metaweb services, <span class="emphasis"><em>mqlread</em></span> is a web-based service: it takes an HTTP request as input and returns an HTTP response as its output.
        </p>
        <p>
          The path to the <span class="emphasis"><em>mqlread</em></span> service on a Metaweb server is <span class="emphasis"><em>/api/service/mqlread</em></span>. To send a <span class="emphasis"><em>mqlread</em></span> query to the Metaweb server running at <span class="emphasis"><em>api.freebase.com</em></span>, for example, you'd use the following URL:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/service/mqlread
</pre>
        <p>
          <span class="emphasis"><em>mqlread</em></span> works with both GET and POST request methods. GET requests are preferred unless the query is so long that POST must be used instead.
        </p>
        <p>
          There are two sources of input to <span class="emphasis"><em>mqlread</em></span> in an HTTP request. The first is the request parameters. For GET requests, these parameters are encoded in the URL itself, following a ? character. For POST requests, the request parameters appear in the body of the request. In both cases, the parameters are URI encoded in the standard way that web browsers encode HTML form submissions. <span class="emphasis"><em>mqlread</em></span> recognizes request parameters <code class="literal">query</code>, <code class="literal">queries</code> and <code class="literal">callback</code>, and these are documented in sub-sections below. Every <span class="emphasis"><em>mqlread</em></span> request must include either the <code class="literal">query</code> or <code class="literal">queries</code> request parameters (but not both). The value of these parameters is a JSON-serialized object known as a <span class="emphasis"><em>query envelope</em></span>. In addition to holding the actual MQL query that is being submitted, this envelope object may also hold additional <span class="emphasis"><em>mqlread</em></span> input in the form of "envelope parameters". Envelopes and envelope parameters are covered in detail below.
        </p>
        <p>
          The second source of <span class="emphasis"><em>mqlread</em></span> input in an HTTP request is HTTP cookies. <span class="emphasis"><em>mqlread</em></span> looks for a cookie named <code class="literal">mwLastWriteTime</code>. This cookie is only necessary in applications that perform MQL writes as well as MQL reads, and ensures that recent writes are always visible to subsequent read requests performed by the same application (or by the same web browser). The <code class="literal">mwLastWriteTime</code> cookie is covered in <a class="xref" href="http://mql.freebaseapps.com/ch06.html" title="Chapter 6. Metaweb Write Services">Chapter 6</a> rather than in this chapter. In general, Metaweb-enabled applications need not track individual cookies. Instead, they can behave like web browsers do: any cookies returned as output by a Metaweb service should be included as input to subsequent requests.
        </p>
        <p>
          The output of the <span class="emphasis"><em>mqlread</em></span> service is the HTTP response body. This body is always (even when errors occur because of bad input) a JSON serialized object in text/plain encoding. This JSON serialized object is known as a <span class="emphasis"><em>response envelope</em></span>, and it is explained in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#responseenvelope" title="4.2.3. The Response Envelope">Section 4.2.3</a> below.
        </p>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="queryparam" name="queryparam"></a>4.2.1. The query Request Parameter
                </h3>
              </div>
            </div>
          </div>
          <p>
            The simplest <span class="emphasis"><em>mqlread</em></span> request includes a single request parameter named <code class="literal">query</code>. The value of this parameters is a JSON-serialized object known as a query envelope. This envelope object must have a property named <code class="literal">query</code>, and may also have additional properties that specify "envelope parameters" – see <a class="xref" href="http://mql.freebaseapps.com/ch04.html#envelopeparameters" title="4.2.4. Envelope Parameters">Section 4.2.4</a>. The value of the <code class="literal">query</code> property in the envelope is your JSON-serialized MQL query. Thus a simple <span class="emphasis"><em>mqlread</em></span> invocation uses a URL like this:
          </p>
          <pre class="programlisting">https://api.freebase.com/api/service/mqlread?query={"query":[{Your MQL here}]}
</pre>
          <p>
            Notice that the word "query" appears twice in this URL. The first (without quotes) is the request parameter, and the second (with quotes) is a property of the envelope object. In this example, the square brackets are part of the MQL query itself, not part of the envelope syntax. Note also that everything after the equals sign should, in practice, be URI-encoded, which transforms quotation marks into <code class="literal">%22</code>, and so forth.
          </p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="queriesparam" name="queriesparam"></a>4.2.2. The queries Request Parameter
                </h3>
              </div>
            </div>
          </div>
          <p>
            <span class="emphasis"><em>mqlread</em></span> allows you to submit more than one MQL query at a time. To do this, you must use the <code class="literal">queries</code> request parameter instead of <code class="literal">query</code>. (Every invocation of <span class="emphasis"><em>mqlread</em></span> must include one or the other, but not both.) The value of the <code class="literal">queries</code> parameter is not a simple query envelope as it is for the <code class="literal">query</code> parameter. Instead, it is a JSON-serialized object known as an <span class="emphasis"><em>outer envelope</em></span>. The outer envelope contains named query envelopes. To submit two queries at once the outer envelope would have two properties. The names of the properties might be <code class="literal">q1</code> and <code class="literal">q2</code>, and their values would be the two query envelopes that describe the two queries to be run:
          </p>
          <pre class="programlisting">{                                       # Start the outer envelope
  "q1": {                               # Query envelope for query named q1
    "query":{First MQL query here}      # Query property of query envelope
  },                                    # End of first query envelope
  "q2": {                               # Start query envelope for query q2
    "query":[{Second MQL query here}]   # Query property of q2
  }                                     # End of second query envelope
}                                       # End of outer envelope.
</pre>
          <p>
            The property names used within an outer envelope are arbitrary, but they appear again in the <span class="emphasis"><em>mqlread</em></span> response.
          </p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="responseenvelope" name="responseenvelope"></a>4.2.3. The Response Envelope
                </h3>
              </div>
            </div>
          </div>
          <p>
            The output of the <span class="emphasis"><em>mqlread</em></span> service is an HTTP response, which consists of a set of HTTP response headers and a response body. The headers are not typically interesting (though Metaweb engineers might be interested in the X-Metaweb-TID header if you're submitting a bug report). In particular <span class="emphasis"><em>mqlread</em></span> is not expected to return cookies as part of its output.
          </p>
          <p>
            The body is the interesting part of the <span class="emphasis"><em>mqlread</em></span> response. It is a UTF-8 encoded JSON-serialized object. This object is known as the response envelope, and its structure mirrors that of the query envelope with the <code class="literal">query</code> property replaced with a <code class="literal">result</code> property. If the request used the <code class="literal">query</code> parameter to submit a single query envelope, then the result is a single response envelope. The following are side-by-side views of a query and response envelope:
          </p>
          <div class="informaltable">
            <table border="1">
              <colgroup>
                <col>
                <col>
              </colgroup>
              <thead>
                <tr>
                  <th>
                    Query Envelope
                  </th>
                  <th>
                    Response Envelope
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <pre class="programlisting">{
  "query": [{ MQL Query Here }]
}
</pre>
                  </td>
                  <td>
                    <pre class="programlisting">{
  "result": [{ MQL Response Here }],
  "status": "200 OK",
  "code": "/api/status/ok",
  "transaction_id":[opaque string value]
}
</pre>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p>
            If the request used the <code class="literal">queries</code> parameter to submit multiple named query envelopes within an outer envelope, then the response is an outer envelope that uses the same names to refer to multiple response envelopes:
          </p>
          <div class="informaltable">
            <table border="1">
              <colgroup>
                <col>
                <col>
              </colgroup>
              <thead>
                <tr>
                  <th>
                    Query Envelopes
                  </th>
                  <th>
                    Response Envelopes
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <pre class="programlisting">{
  "q1": {
    "query":{First MQL query here}
  },
  "q2": {
    "query":[{Second MQL query here}]
  }
}
</pre>
                  </td>
                  <td>
                    <pre class="programlisting">{
  "q1": {
    "result":{First MQL result here},
    "code": "/api/status/ok"
  },
  "q2": {
    "result":[{Second MQL result here}],
    "code": "/api/status/ok"
  },
  "status": "200 OK",
  "code": "/api/status/ok",
  "transaction_id":[opaque string value]
}
</pre>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p>
            Notice that response envelopes include <code class="literal">code</code>, <code class="literal">status</code>, and <code class="literal">transaction_id</code> properties. The <code class="literal">code</code> property is the most important: it specifies a success or failure status code (as a string) for the query. If the query was successful then the value of this property will be "/api/status/ok". If <code class="literal">code</code> does not equal "/api/status/ok", then there was an error of some sort, and the response envelope will include additional details in a <code class="literal">messages</code> array. See <a class="xref" href="http://mql.freebaseapps.com/ch04.html#mqlreaderrors" title="4.2.6. mqlread Error Codes">Section 4.2.6</a> for further details about status codes and error messages, including details on the <code class="literal">status</code> and <code class="literal">transaction_id</code> properties.
          </p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="envelopeparameters" name="envelopeparameters"></a>4.2.4. Envelope Parameters
                </h3>
              </div>
            </div>
          </div>
          <p>
            If you use the <code class="literal">query</code> request parameter you specify a single query envelope as its value. If you use <code class="literal">queries</code> instead, you specify one or more query envelopes within an outer envelope. In either case, each query envelope must include a property named <code class="literal">query</code> that specifies the MQL query to be executed. Each envelope may also include additional properties, known as "envelope parameters" that provide additional input to <span class="emphasis"><em>mqlread</em></span> and specify how the query should be run. <span class="emphasis"><em>mqlread</em></span> supports envelope parameters named <code class="literal">cursor</code>, <code class="literal">escape</code>, <code class="literal">lang</code> <code class="literal">as_of_time</code> and <code class="literal">uniqueness_failure</code>. These parameters are described below.
          </p>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">
                    <a id="cursors" name="cursors"></a>4.2.4.1. Fetching Large Result Sets with Cursors
                  </h4>
                </div>
              </div>
            </div>
            <p>
              Recall that MQL queries are implicitly limited to returning 100 results. You can use the MQL <code class="literal">limit</code> directive to specify a different limit, but when there is a very large result set, specifying a very large limit may cause your query to time out. When you expect that your query will have many results, and you want to retrieve all of those results, you should use a <span class="emphasis"><em>cursor</em></span> <sup>[<a class="footnote" href="http://mql.freebaseapps.com/ch04#ftn.id2959411" id="id2959411" name="id2959411">17</a>]</sup>. A cursor is simply a way of keeping track of your position within a large set of results, and it enables you to retrieve the results of a query batch by batch with multiple sequential <span class="emphasis"><em>mqlread</em></span> invocations. Cursors are demonstrated later in this chapter in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metawebpython" title="4.8. Metaweb Services with Python">Section 4.8</a>.
            </p>
            <p>
              To begin a new query that uses a cursor, include a <code class="literal">cursor</code> property with the value <code class="literal">true</code> in the query envelope. The response envelope (see <a class="xref" href="http://mql.freebaseapps.com/ch04.html#responseenvelope" title="4.2.3. The Response Envelope">Section 4.2.3</a> will then contain a <code class="literal">cursor</code> property. If the value of the <code class="literal">cursor</code> in the response is <code class="literal">false</code>, it means that all results have been delivered. Otherwise, that property will be a long string of opaque data. Use this string as the value of the <code class="literal">cursor</code> property in the query envelope, and submit that query envelope again (leaving the query itself unchanged). This time the response envelope will contain the second batch of results and a new value for the <code class="literal">cursor</code> property. Repeat these steps until the <code class="literal">cursor</code> property of the response envelope is <code class="literal">false</code>.
            </p>
            <p>
              It is important to understand that cursors only work when multiple results are expected at the top-level of the query. The <code class="literal">cursor</code> property is part of the <code class="literal">mqlread</code> query envelope syntax, not part of MQL itself, and it cannot be applied to sub-queries of a query. Another way to say this is that it only makes sense to include <code class="literal">"cursor":true</code> in an envelope if the first character following <code class="literal">"query":</code> in the envelope is <code class="literal">[</code>. The query must be expressed as an array in order for a cursor to be meaningful. It is legal, but never useful, for example, to use a cursor in this query envelope:
            </p>
            <pre class="programlisting">{
  "cursor":true,
  "query": {
    "type":"/music/artist",
    "name":"The Police",
    "album":[]
  }
}
</pre>
            <p>
              If you want to use a cursor to retrieve a list of albums in batches, the array of albums must be at the toplevel of the query:
            </p>
            <pre class="programlisting">{
  "cursor":true,
  "query": [{
    "type":"/music/album",
    "artist":"The Police",
    "name":null,
    "limit":10
  }]
}
</pre>
            <p>
              Note the addition of the <code class="literal">limit</code> directive to the query to specify the size of each batch we want returned.
            </p>
            <p>
              Cursor values remain valid after they are used. Once you have downloaded result batches sequentially, you can reuse saved cursor values to download those batches again in whatever order you like. (Except for the first batch which does not have a cursor.) Results retrieved with cursors are based on the state of the database as it existed when the first query (with <code class="literal">"cursor":true</code>) was issued. <sup>[<a class="footnote" href="http://mql.freebaseapps.com/ch04#ftn.id2959561" id="id2959561" name="id2959561">18</a>]</sup> So results retrieved with a given cursor will always be the same, and will ignore any insertions or deletions that occurred after the original query. Cursors can be assumed to have a lifetime at least as long as that of your application. But updates to Metaweb's backend software can invalidate cursors, so you should not assume that they live forever. Cursors are not intended to be stored in databases or files or encoded into long-lived URLs, for example. They should not be considered "permalinks" or persistent bookmarks to a past state of the database.
            </p>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">
                    <a id="htmlescape" name="htmlescape"></a>4.2.4.2. Disabling HTML Escapes
                  </h4>
                </div>
              </div>
            </div>
            <p>
              By default, <span class="emphasis"><em>mqlread</em></span> uses HTML entities &amp;lt;, &amp;gt;, and &amp;amp; in its responses in place of the characters &lt;, &gt;, and &amp;, and this means that text returned by <span class="emphasis"><em>mqlread</em></span> is safe for display in web browsers. To disable this escaping, add an <code class="literal">escape</code> parameter to the query envelope, and set its value to <code class="literal">false</code>. (You can also explicitly request HTML escaping with <code class="literal">"escape":"html"</code>, but this is the default behavior and is not required.) If you do disable HTML escaping, you should be careful never to display the <span class="emphasis"><em>mqlread</em></span> output in a web browser, since it could contain <code class="literal">&lt;script&gt;</code> tags that execute arbitrary JavaScript code, for example.
            </p>
            <p>
              The <code class="literal">escape</code> envelope parameter was demonstrated in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.pl" title="Example 4.2. albumlist2.pl: a better Perl album lister">Example 4.2</a> and we'll see it again in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.py" title="Example 4.3. albumlist.py: listing albums with Python">Example 4.3</a>.
            </p>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">
                    <a id="preferredlanguage" name="preferredlanguage"></a>4.2.4.3. Specifying Your Preferred Language
                  </h4>
                </div>
              </div>
            </div>
            <p>
              As you know, Metaweb objects can have more than one value for the <code class="literal">name</code> property, but can have only one value in any given language. When you request the name of an object, it returns the name in your preferred language. The default language is English, but you can specify a different preference with the envelope parameter <code class="literal">lang</code>. The value of this parameter should be a language id in the <code class="literal">/lang</code> namespace. The following query envelope, for example, asks for the Spanish name of the French language:
            </p>
            <pre class="programlisting">{
  "lang":"/lang/es",
  "query": {
    "id":"/lang/fr",
    "name":null
  }
}
</pre>
            <p>
              At the time of this writing, <sup>[<a class="footnote" href="http://mql.freebaseapps.com/ch04#ftn.id2959725" id="id2959725" name="id2959725">19</a>]</sup> <span class="emphasis"><em>mqlread</em></span> supports only a single preferred language. If no name exists in the specified language, then <code class="literal">null</code> is returned. In the future, the <code class="literal">lang</code> envelope parameter is likely to evolve to support language fallbacks, and you should be able to request, for example, a name in Spanish, or in English if no Spanish name exists.
            </p>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">
                    <a id="asoftime" name="asoftime"></a>4.2.4.4. Making Queries in the Past
                  </h4>
                </div>
              </div>
            </div>
            <p>
              Use the <code class="literal">as_of_time</code> envelope parameter in a <span class="emphasis"><em>mqlread</em></span> query to specify that the query should be performed historically, against the Metaweb database as it existed at the specified moment in the past. The Metaweb database has a journaled structure, making this kind of historical query relatively simple and efficient to perform. Note, however, that type and schema information used in processing the query is current rather than historical.
            </p>
            <p>
              The value of the <code class="literal">as_of_time</code> parameter should be a timestamp in the ISO 8601 format (see <a class="xref" href="http://mql.freebaseapps.com/ch02.html#typedatetime" title="2.5.8. /type/datetime">Section 2.5.8</a>) used by <code class="literal">/type/datetime</code> values in MQL. For example, the value "2007-02-03" represents midnight on February 3rd, 2007, and the value "2008-01-01T17:00Z" represents 5PM on January 1st, 2008. Metaweb timestamps are always stored in UTC (or GMT) time, and the <code class="literal">as_of_time</code> parameter assumes that your timestamp is specified in UTC. You may append Z to your timestamp to make this timezone explicit but you may not explicitly specify any other timezone. That is, you cannot add -08:00 to specify US Pacific time, for example.
            </p>
            <p>
              Here are two queries (in their query envelopes, and named "now" and "then" in an outer envelope) that allow us to see how the number of defined types has grown over time:
            </p>
            <pre class="programlisting">{
  "now": {
    "query": {
        "return":"count",
        "type":"/type/type"
    }
  },
  "then": {
    "query": {
        "return":"count",
        "type":"/type/type"
    },
    "as_of_time":"2008-01-01"
  }
}
</pre>
            <p>
              On 2008-04-25, freebase.com returned the following outer response envelope, showing the addition of over 900 types in under 5 months:
            </p>
            <pre class="programlisting">{
  "status" : "200 OK",
  "code" : "/api/status/ok",
  "now" : {
    "code" : "/api/status/ok",
    "result" : 5548
  },
  "then" : {
    "code" : "/api/status/ok",
    "result" : 4623
  }
}
</pre>
            <p>
              In addition to the ability to run queries "in the past", Metaweb allows you to query the modification history of any object. See <a class="xref" href="http://mql.freebaseapps.com/ch03.html#history" title="3.7.4. History">Section 3.7.4</a> for details.
            </p>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">
                    <a id="uniqueness_failure" name="uniqueness_failure"></a>4.2.4.5. Preventing Uniqueness Errors
                  </h4>
                </div>
              </div>
            </div>
            <p>
              When a MQL query or sub-query returns more than one result, but is not enclosed in square brackets to indicate that an array of results is expected, Metaweb normally returns an error code indicating that a uniqueness error has occurred. We saw in <a class="xref" href="http://mql.freebaseapps.com/ch03.html#uniqueerror" title="3.2.4. Multiple Results and Uniqueness Errors">Section 3.2.4</a>, for example, that the following query causes an uniqueness error because the object representing The Police has more than one type:
            </p>
            <pre class="programlisting">{"id":"/en/the_police", "type":null}
</pre>
            <p>
              You can prevent this kind of error by setting the envelope parameter <code class="literal">uniqueness_failure</code> to "soft". (The default value is "hard"). With this parameter set to "soft", Metaweb simply returns one of the matching results, discards the others, and does not return an error or give any other indication that additional results are available.
            </p>
            <p>
              Picking one (effectively random) result from a set and discarding all the others is not usually a useful strategy for handling multiple results, and the <code class="literal">uniqueness_failure</code> envelope parameter is not intended for use with queries like the one above. As a general rule, if a property is allowed to have more than one value, then queries of that property should be placed within square brackets.
            </p>
            <p>
              When a property definition is changed to make the property unique after it is initially defined as non-unique, then it is possible (but rare) to find multiple values for a nominally unique property. You may want to use the <code class="literal">uniqueness_failure</code> envelope parameter when working with such a theoretically-unique property that is not yet unique in practice.
            </p>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="callbackparam" name="callbackparam"></a>4.2.5. The callback Request Parameter
                </h3>
              </div>
            </div>
          </div>
          <p>
            Every <span class="emphasis"><em>mqlread</em></span> request must have a <code class="literal">query</code> or <code class="literal">queries</code> request parameter. They may also optionally have a <code class="literal">callback</code> parameter (this is a request parameter, not an envelope parameter). This parameter is used in JavaScript-based Metaweb applications and allows <span class="emphasis"><em>mqlread</em></span> to be invoked using dynamically-generated <code class="literal">&lt;script&gt;</code> tags. (This <code class="literal">&lt;script&gt;</code>-based technique for client-server communication is commonly known as JSONP and we'll see examples in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#javascriptmql" title="4.5. Metaweb Queries with JavaScript">Section 4.5</a>.)
          </p>
          <p>
            The value of the <code class="literal">callback</code> parameter should be the name of a JavaScript function (without parentheses), such as <code class="literal">processMQLResponse</code>. Including the <code class="literal">callback</code> parameter in a <span class="emphasis"><em>mqlread</em></span> invocation causes a small but very important change in the <span class="emphasis"><em>mqlread</em></span> output. In order to understand these changes, recall that <span class="emphasis"><em>mqlread</em></span> always returns a JSON-serialized object in the HTTP response body. Also recall that JSON is a subset of JavaScript which means that any JSON-serialized object that can be parsed by a JavaScript interpreter to re-create the object it represents. If you include a <code class="literal">callback</code> parameter in a <span class="emphasis"><em>mqlread</em></span> invocation, <span class="emphasis"><em>mqlread</em></span> returns a JSON-serialized object inside a JavaScript function invocation of the callback function you specify. Suppose, for example, that you invoke <span class="emphasis"><em>mqlread</em></span> with a URL like this:
          </p>
          <pre class="programlisting">https://api.freebase.com/api/service/mqlread?callback=cb&amp;query={"query":[{...}]}
</pre>
          <p>
            In this case, the response will look like this:
          </p>
          <pre class="programlisting">cb({
  "status":"200 OK",
  "code":"/api/status/ok",
  "result":[{...MQL result here...}]
})
</pre>
          <p>
            The JSON-serialized result envelope object is prefixed with the name of the callback function and an open parenthesis and is suffixed with a matching close parenthesis. This seems like a trivial change, but it transforms a bare JSON object into a JavaScript method invocation with that object as its argument. If the <span class="emphasis"><em>mqlread</em></span> query URL is used as the <code class="literal">src</code> attribute of a <code class="literal">&lt;script&gt;</code> tag, the <span class="emphasis"><em>mqlread</em></span> response becomes executable JavaScript content, and the callback function you name gets passed the response envelope object to process however it wants.
          </p>
          <p>
            There is one other effect of using the <code class="literal">callback</code> parameter in a request. It forces <code class="literal">mqlread</code> to always return an HTTP status code of "200 OK", even when the query envelope is malformed and unparseable. The true HTTP status (which would otherwise have been returned) is available from the <code class="literal">status</code> property of the response envelope, and this enables a callback function to handle errors as well as successful queries.
          </p>
          <p>
            See <a class="xref" href="http://mql.freebaseapps.com/ch04.html#javascriptmql" title="4.5. Metaweb Queries with JavaScript">Section 4.5</a> for practical examples that use the <code class="literal">callback</code> request parameter.
          </p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="mqlreaderrors" name="mqlreaderrors"></a>4.2.6. mqlread Error Codes
                </h3>
              </div>
            </div>
          </div>
          <p>
            The <span class="emphasis"><em>mqlread</em></span> response envelope does not always include the results of your query. Errors can occur if you invoke <span class="emphasis"><em>mqlread</em></span> incorrectly, if you specify an invalid MQL query, if your query times out, or if there if there is an internal error on the Metaweb server. This section explains how to check for and handle <span class="emphasis"><em>mqlread</em></span> errors.
          </p>
          <p>
            If you invoke <span class="emphasis"><em>mqlread</em></span> without either the <code class="literal">query</code> or <code class="literal">queries</code> parameter, or if the value of that parameter is not a valid JSON string, it responds with an HTTP status "400 Bad Request". Even though this is an HTTP error code, the response still includes a response body and that body is still a JSON object that you can parse. It looks something like this:
          </p>
          <pre class="programlisting">{
  "status": "400 Bad request", 
  "code": "/api/status/error", 
  "messages": [
    {
      "info": {
        "value": null
      }, 
      "message": "one of query=, or queries= must be provided", 
      "code": "/api/status/error/input/invalid"
    }
  ],
  "transaction_id":"cache;cache01.sandbox.sfo1:8101;2008-09-12T21:33:30Z;0001"
}
</pre>
          <p>
            If you invoke <span class="emphasis"><em>mqlread</em></span> with correct parameters and a parseable query envelope, then it will always return an HTTP status code of "200 OK". This does not mean, however, that no error has occurred. If the query envelope is valid JSON but does not have a <code class="literal">query</code> property, for example, then you get this response:
          </p>
          <pre class="programlisting">{
  "status": "200 OK", 
  "code": "/api/status/error", 
  "messages": [
    {
      "info": {
        "key": "query"
      }, 
      "message": "Missing 'query' parameter", 
      "code": "/api/status/error/envelope/parse"
    }
  ],
  "transaction_id":"cache;cache01.sandbox.sfo1:8101;2008-09-12T21:35:19Z;0001"
}
</pre>
          <p>
            And if the invocation is correct and the envelope is correct but the MQL query is invalid, then you might get a response like this:
          </p>
          <pre class="programlisting">{
  "status": "200 OK", 
  "code": "/api/status/error", 
  "messages": [
    {
      "info": {
        "expected_type": "/music/artist", 
        "property": "albums"
      }, 
      "query": {
        "albums": [], 
        "type": "/music/artist", 
        "id": "/en/the_police", 
        "error_inside": "."
      }, 
      "message": "Type /music/artist does not have property albums", 
      "code": "/api/status/error/mql/type", 
      "path": ""
    }
  ],
  "transaction_id":"cache;cache01.sandbox.sfo1:8101;2008-09-12T21:36:51Z;0001"
}
</pre>
          <p>
            If your query is simply too big (such as asking for the names and discographies of 10,000 bands) the query will timeout and <span class="emphasis"><em>mqlread</em></span> will return a response like this:
          </p>
          <pre class="programlisting">{
  "status": "200 OK", 
  "code": "/api/status/error", 
  "messages": [
    {
      "info": {
        "detail": [
          "timed out"
        ], 
        "timeout": 8.0
      }, 
      "message": "Query timeout", 
      "code": "/api/status/error/mql/timeout"
    }
  ],
  "transaction_id":"cache;cache01.sandbox.sfo1:8101;2008-09-12T21:39:01Z;0004"
}
</pre>
          <p>
            Each of these error response envelopes includes the properties <code class="literal">status</code>, <code class="literal">transaction_id</code>, <code class="literal">code</code>, and <code class="literal">messages</code>. The <code class="literal">status</code> property simply repeats the HTTP status code. If you check the HTTP status code, you can ignore the <code class="literal">status</code> property. But if you use the <code class="literal">callback</code> parameter in your request, then <span class="emphasis"><em>mqlread</em></span> will return a HTTP status of "200 OK", even when invocation errors occur. In this case the <code class="literal">status</code> property can tell you that an invocation error occurred.
          </p>
          <p>
            The <code class="literal">transaction_id</code> property is always present in the response envelope whether or not an error occurred. Its value is a unique identifier for your request and enables Metaweb engineers to look it up in their internal log files. You should include the value of this property whenever you report a bug or ask a question about a query on the Metaweb developers mailing list.
          </p>
          <p>
            The <code class="literal">code</code> property specifies the error code for the query. It is present in every response envelope, and you should always check this property after parsing the response from <span class="emphasis"><em>mqlread</em></span>. The value of this property is always a string: if it is "/api/status/ok", then the query was successful and no error occurred. Otherwise something went wrong.
          </p>
          <p>
            When the value of the <code class="literal">code</code> property is "/api/status/ok", the response envelope contains the query results as the value of a property named <code class="literal">result</code>. When <code class="literal">code</code> has any other value, the response envelope includes a <code class="literal">messages</code> property instead of a <code class="literal">result</code> property. The value of the <code class="literal">messages</code> property is an array (usually of length 1) of message objects each of which has the following properties:
          </p>
          <div class="variablelist">
            <dl>
              <dt>
                <span class="term"><code class="literal">code</code></span>
              </dt>
              <dd>
                <p>
                  A more detailed error code that more precisely specifies the nature of the error. Note that this <code class="literal">code</code> property of the message object is usually distinct from, and more informative than, the <code class="literal">code</code> property of the response envelope.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">message</code></span>
              </dt>
              <dd>
                <p>
                  A human-readable description of the error.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">info</code></span>
              </dt>
              <dd>
                <p>
                  An object that provides additional details about the error. The properties of this object depend on the error <code class="literal">code</code>.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">query</code></span>
              </dt>
              <dd>
                <p>
                  For errors that result from an invalid MQL query, this property is a copy of the query object with the addition of a special <code class="literal">error_inside</code> property, to indicate where error occurs.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">path</code></span>
              </dt>
              <dd>
                <p>
                  When the message object contains a <code class="literal">query</code> property, it also contains a <code class="literal">path</code> property that specifies the "path" of property names from the root of the MQL query to the the location of the error. This is an alternative to the <code class="literal">error_inside</code> property for locating the source of the error. If the error is in the outermost object of the query, then this property is just an empty string.
                </p>
              </dd>
            </dl>
          </div>
          <p>
            The descriptions above of error-related properties are valid when you use the <code class="literal">query</code> request parameter. If you use <code class="literal">queries</code> instead, there are a few differences you should be aware of. First, the <code class="literal">status</code> property appears only in outer envelope, not in the individual response envelopes it contains. Second, there are <code class="literal">code</code> properties both in the outer envelope and in the individual response envelopes. The outer <code class="literal">code</code> will only indicate an error, however, if there was an invocation error (such as a unparseable query envelope), and in this case there won't be response envelopes inside the outer envelope. As long as <span class="emphasis"><em>mqlread</em></span> is correctly invoked, the <code class="literal">code</code> property of the outer envelope will be "/api/status/ok", even if there were errors in one or more (or all) of the queries. It is the <code class="literal">code</code> property of the individual response envelopes that specify the status of each individual query. Third (and this really follows from the second), the <code class="literal">messages</code> property only appears in the outer envelope for invocation errors. Otherwise, <code class="literal">messages</code> properties always appear within the response envelopes.
          </p>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.pl" title="Example 4.2. albumlist2.pl: a better Perl album lister">Example 4.2</a> included example code for <span class="emphasis"><em>mqlread</em></span> error handling, and many examples that follow will also include error handling code. The general rule is to check the <code class="literal">code</code> property of any response envelope before "opening" it to extract the <code class="literal">result</code>. (And if the response envelope is inside an outer envelope, you must also check the <code class="literal">code</code> of that outer envelope before opening it to extract the response envelope.) If you find a <code class="literal">code</code> that is not "/api/status/ok", you can typically construct a suitable error message with <code class="literal">messages[0].code</code> and <code class="literal">messages[0].message</code>. If you have reason to expect a certain class of errors, you can refine your error reporting based on <code class="literal">messages[0].code</code> and <code class="literal">messages[0].info</code>.
          </p>
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="pythonalbumlistener" name="pythonalbumlistener"></a>4.3. A Python Album Lister
              </h2>
            </div>
          </div>
        </div>
        <p>
          Now that we've seen how <span class="emphasis"><em>mqlread</em></span> works in more formal detail, let's return to example code, and re-write our album listing script in Python. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.py" title="Example 4.3. albumlist.py: listing albums with Python">Example 4.3</a> is a Python program that:
        </p>
        <div class="itemizedlist">
          <ul>
            <li>
              <p>
                expresses a MQL query as a Python data structure
              </p>
            </li>
            <li>
              <p>
                wraps the query in an envelope object;
              </p>
            </li>
            <li>
              <p>
                sets the value of envelope parameters in the envelope object;
              </p>
            </li>
            <li>
              <p>
                serializes the envelope object to a JSON string;
              </p>
            </li>
            <li>
              <p>
                URI encodes the serialized envelope;
              </p>
            </li>
            <li>
              <p>
                Uses the serialized and encoded envelope as the value of the <code class="literal">query</code> parameter in a <span class="emphasis"><em>api.freebase.com</em></span> URL;
              </p>
            </li>
            <li>
              <p>
                obtains the query result, in text form, by fetching the contents of the URL;
              </p>
            </li>
            <li>
              <p>
                parses the JSON string returned by <span class="emphasis"><em>mqlread</em></span> into a response envelope object;
              </p>
            </li>
            <li>
              <p>
                checks the <code class="literal">code</code> property in the response envelope to determine if the query was successful (if not, it extracts the error message from the envelope, prints the message and exits);
              </p>
            </li>
            <li>
              <p>
                gets the query result from the envelope, extracts the array of albums, and prints their name and release dates.
              </p>
            </li>
          </ul>
        </div>
        <p>
          This code relies on the <code class="literal">simplejson</code> module for JSON encoding and parsing. You can find the simplejson code at <span class="emphasis"><em>http://cheeseshop.python.org/pypi/simplejson</em></span>.
        </p>
        <div class="example">
          <a id="albumlist.py" name="albumlist.py"></a>
          <p class="title">
            <b>Example 4.3. albumlist.py: listing albums with Python</b>
          </p>
          <div class="example-contents">
            <pre class="programlisting">import sys            # Command-line arguments, etc.
import simplejson     # JSON encoding.
import urllib         # URI encoding.
import urllib2        # High-level URL content fetching.

# These are some constants we'll use.
SERVER = 'api.freebase.com'              # Metaweb server
SERVICE = '/api/service/mqlread'         # Metaweb service

# Compose our MQL query as a Python data structure.
# The query is an array in case multiple bands share the same name.
band = sys.argv[1]                       # The desired band, from command line.
query = [{'type': '/music/artist',       # Our MQL query in Python.
          'name': band,                  # Place the band in the query.
          'album': [{ 'name': None,      # None is Python's null.
                      'release_date': None,
                      'sort': 'release_date' }]}]

# Put the query in an envelope
envelope = {
    'query': query,              # The query property specifies the query.
    'escape': False              # Turns off HTML escaping.
    }

# These five lines are the key code for using mqlread
encoded = simplejson.dumps(envelope)            # JSON encode the envelope.
params = urllib.urlencode({'query':encoded})    # Escape request parameters.
url ='http://%s%s?%s' % (SERVER,SERVICE,params) # The URL to request.
f = urllib2.urlopen(url)                        # Open the URL as a file.
response = simplejson.load(f)                   # Read and JSON parse response.

# Check for errors and exit with a message if the query failed.
if response['code'] != '/api/status/ok':                   # If not okay...
    error = response['messages'][0]                        # First msg object.
    sys.exit('%s: %s' % (error['code'], error['message'])) # Display code,msg.

# No errors, so handle the result
result = response['result']           # Open the response envelope, get result.

# Check the number of matching bands
if len(result) == 0:
    sys.exit('Unknown band')
elif len(result) &gt; 1:
    print "Warning: multiple bands named " + band + ". Listing first only."

result = result[0]                    # Get first band from array of matches.
if not result['album']:               # Exit if band has no albums
    sys.exit(band + ' has no known albums.')

for album in result['album']:         # Loop through the result albums.
    name = album['name']              # Album name.
    date = album['release_date']      # Release date timestamp or null.
    if not date: date = ''            
    else: date = ' [%s]' % date[0:4]  # Just the 4-digit year in brackets.
    print "%s%s" % (name, date)       # Print name and date.
</pre>
          </div>
        </div><br class="example-break">
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="phpmqlexample" name="phpmqlexample"></a>4.4. A Metaweb-enabled PHP Application
              </h2>
            </div>
          </div>
        </div>
        <p>
          In this section, we'll demonstrate how to create an online version of our album-lister application. We'll use the the server-side scripting language PHP to create the web application that was shown in <a class="xref" href="http://mql.freebaseapps.com/ch01.html#albumlist" title="Figure 1.2. A Metaweb-enabled web application">Figure 1.2</a> of <a class="xref" href="http://mql.freebaseapps.com/ch01.html" title="Chapter 1. Introduction">Chapter 1</a>. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.php" title="Example 4.4. metaweb.php: using mqlread with PHP">Example 4.4</a> is a PHP file that defines a class named <code class="literal">Metaweb</code>. This class has a single method, named <code class="literal">read</code> that takes a MQL query as a PHP data structure and returns the query result as a PHP data structure. Although the language and library details differ, the code that implements this <code class="literal">read</code> method is much like the code you've seen in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.pl" title="Example 4.2. albumlist2.pl: a better Perl album lister">Example 4.2</a> and <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.py" title="Example 4.3. albumlist.py: listing albums with Python">Example 4.3</a>.
        </p>
        <p>
          The code in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.php" title="Example 4.4. metaweb.php: using mqlread with PHP">Example 4.4</a> is commented and you should be able to follow it even if you are not familiar with PHP. One point to note is that in PHP the data structure known as an array works as both a sequential array and as an associative array. That is, JSON objects and JSON arrays are both arrays in PHP. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.php" title="Example 4.4. metaweb.php: using mqlread with PHP">Example 4.4</a> depends on an external module for JSON serialization and parsing. The module used here is from http:<span class="emphasis"><em>//pear.php.net</em></span>.
        </p>
        <div class="example">
          <a id="metaweb.php" name="metaweb.php"></a>
          <p class="title">
            <b>Example 4.4. metaweb.php: using mqlread with PHP</b>
          </p>
          <div class="example-contents">
            <pre class="programlisting">&lt;?php
/*
 * The Metaweb class defines a read() method for invoking the Metaweb
 * mqlread service on api.freebase.com. read() takes a MQL query (as a
 * PHP array), sends that query to the mqlread service and retrieves 
 * the response. It parses the response to a PHP array, and extracts
 * the query result from the response envelope and returns it. If the
 * query fails, it returns null (without providing useful diagnostics).
 */
require "JSON.php"; // A JSON encoder/decoder from http://pear.php.net

class Metaweb {
  var $json;  // Holds the JSON encoder/decoder object
  var $URL = "http://api.freebase.com/api/service/mqlread";

  // Our constructor function sets up the JSON encoder/decoder
  function Metaweb() {
    // Set up our JSON encoder and decoder object
    $this-&gt;json = new Services_JSON(SERVICES_JSON_LOOSE_TYPE);
  }
  
  // This method submits a query and synchronously returns its result.
  function read($queryobj) {
    // Put the query into an envelope object
    $envelope = array("query" =&gt; $queryobj);

    // Serialize the envelope object to JSON text
    $serialized = $this-&gt;json-&gt;encode($envelope);

    // Then URL encode the serialized text
    $encoded = urlencode($serialized);

    // Now build the URL that represents the query
    $url = $this-&gt;URL . "?query=" . $encoded;

    // Use the curl library to send the query and get response text
    $request = curl_init($url);

    // Return the result instead of printing it out.
    curl_setopt($request, CURLOPT_RETURNTRANSFER, TRUE);

    // Now fetch the URL
    $responsetext = curl_exec($request);
    curl_close($request);

    // Parse the server's response from JSON text into a PHP array
    $response = $this-&gt;json-&gt;decode($responsetext);

    // Return null if the query was not successful
    if ($response["code"] !== "/api/status/ok")
        return null;

    // Otherwise, return the query result from the envelope
    return $response["result"];
  }
}
?&gt;
</pre>
          </div>
        </div><br class="example-break">
        <p>
          With the PHP utility function defined in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.php" title="Example 4.4. metaweb.php: using mqlread with PHP">Example 4.4</a>, it becomes easy to write simple Metaweb-enabled web applications in PHP. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.php" title="Example 4.5. albumlist.php: A Metaweb-enabled web application in PHP">Example 4.5</a> demonstrates. It displays an HTML form in which the user can enter the name of a band. When the form is submitted, it lists the albums by that band.
        </p>
        <div class="example">
          <a id="albumlist.php" name="albumlist.php"></a>
          <p class="title">
            <b>Example 4.5. albumlist.php: A Metaweb-enabled web application in PHP</b>
          </p>
          <div class="example-contents">
            <pre class="programlisting">&lt;html&gt;
&lt;body&gt;
&lt;form&gt;Band: &lt;input type="text" name="band"&gt;&lt;input type="submit"&gt;&lt;/form&gt;
&lt;?php
$band = $_GET["band"];        // What band is specified in the URL?
if ($band) {                  // Only list albums if a band has been specified.
  require "metaweb.php";      // Import Metaweb utility code.
  $metaweb = new Metaweb();   // Create a Metaweb object.

  // Build a MQL request for the list of albums by the band
  $query = array("type" =&gt; "/music/artist", // We want a musical artist.
                 "name" =&gt; $band,           // This is its name.
                 "album" =&gt; array());       // Fill in this empty albums array!
  
  // Submit the query using the utility function defined earlier
  $result = $metaweb-&gt;read($query);
  
  // Now output the query results in HTML
  if ($result) {                              // If we got a result...
      echo "&lt;hr&gt;&lt;h1&gt;Albums by " . $band . "&lt;/h1&gt;"; // Display page title.
      $albums = $result["album"];                  // Get the array of albums.
      foreach ($albums as $album)                  // For each album...
          echo $album . "&lt;br&gt;";                    // ...display album name.
  }
  else {                                      // Otherwise, print error msg.
      echo "&lt;hr&gt;&lt;b&gt;Unknown band: " . $band . "&lt;/b&gt;"; 
  }
}
?&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
          </div>
        </div><br class="example-break">
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="javascriptmql" name="javascriptmql"></a>4.5. Metaweb Queries with JavaScript
              </h2>
            </div>
          </div>
        </div>
        <p>
          Since the MQL syntax is based on JSON, Metaweb queries are most gracefully expressed in JavaScript. We haven't seen a JavaScript-based Metaweb application so far for one important reason: the <span class="emphasis"><em>same-origin policy</em></span>. The same-origin policy is a sweeping (but necessary) security restriction in JavaScript that says that code embedded in a document that was served by server A can only interact with content that is also served by server A. This restriction applies to the <code class="literal">XMLHttpRequest</code> object which is what is typically used to fetch the contents of a URL. A web application hosted at <span class="emphasis"><em>api.freebase.com</em></span> can use <code class="literal">XMLHttpRequest</code> to submit MQL queries to the <span class="emphasis"><em>mqlread</em></span> service on that same server, but this is not allowed for web applications hosted on any other server.
        </p>
        <p>
          There are two workarounds to this restriction. The first, and most obvious, is to run a proxy script on your own site that behaves like the <span class="emphasis"><em>mqlread</em></span> service but simply forwards your query to <span class="emphasis"><em>api.freebase.com</em></span>.
        </p>
        <p>
          The second workaround is known as JSONP and relies on the fact that a query result, in JSON format, is valid JavaScript code. This means that a <span class="emphasis"><em>mqlread</em></span> URL can be used as the value of the <code class="literal">src</code> attribute of a <code class="literal">&lt;script&gt;</code> tag. When the server returns its result, the <code class="literal">&lt;script&gt;</code> tag evaluates the JSON text as JavaScript code. Evaluating the JSON text creates the JavaScript object we want, but to make this scheme work, the script then has to be able to do something with that object. The solution is to use the <code class="literal">callback</code> request parameter (which was described in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#callbackparam" title="4.2.5. The callback Request Parameter">Section 4.2.5</a>). If the URL for your <span class="emphasis"><em>mqlread</em></span> invocation includes a <code class="literal">callback</code> parameter, then <span class="emphasis"><em>mqlread</em></span> will take the value of that parameter to be the name of a JavaScript function. Then, instead of simply returning a JSON text, it will return the specified function name, an open parenthesis, the JSON text and a close parenthesis. When used this way with a <code class="literal">&lt;script&gt;</code> tag, the JSON text is evaluated, and the object that results is passed to the specified function (which you must have defined previously).
        </p>
        <p>
          We use the <code class="literal">&lt;script&gt;</code>-based JSONP technique in this chapter: it is simple, elegant and in common use across the internet.
        </p>
        <p>
          One thing you'll notice about our JavaScript examples here is that they are asynchronous: when you submit a query you do not get the result immediately. Instead, the callback function you specify is invoked when the result is available. This asynchronous programming model is common in client-side JavaScript, but is substantially different from the synchronous model demonstrated in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.php" title="Example 4.4. metaweb.php: using mqlread with PHP">Example 4.4</a> and other examples.
        </p>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="id2961111" name="id2961111"></a>4.5.1. Invoking mqlread with the jQuery Library
                </h3>
              </div>
            </div>
          </div>
          <p>
            Let's jump right in. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#simplelist.html" title="Example 4.6. simplelist.html: Listing albums with jQuery">Example 4.6</a> is an album lister web application like <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.php" title="Example 4.5. albumlist.php: A Metaweb-enabled web application in PHP">Example 4.5</a>, but it communicates with <span class="emphasis"><em>freebase.com</em></span> using JavaScript on the client side instead of PHP on the server side. It uses the popular <span class="emphasis"><em>jQuery</em></span> library to do JSONP-based interaction with <span class="emphasis"><em>mqlread</em></span> and to build and traverse the HTML document that displays the query results. Download <span class="emphasis"><em>jquery.js</em></span> (version 1.2 or later) from <span class="emphasis"><em><a class="ulink" href="http://jquery.com/">http://jquery.com</a></em></span>. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#simplelist.html" title="Example 4.6. simplelist.html: Listing albums with jQuery">Example 4.6</a> also relies an external library named <span class="emphasis"><em>json2.js</em></span>. This file defines JavaScript functions for parsing and serializing JSON. The code for this module is in the public domain and is available online at <span class="emphasis"><em><a class="ulink" href=""></a></em></span>.
          </p>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#simplelist.html" title="Example 4.6. simplelist.html: Listing albums with jQuery">Example 4.6</a> is an HTML file that consists mainly of HTML code. There is a short HTML body that defines an input field into which you can type the name of a band and an HTML <code class="literal">&lt;div&gt;</code> tag into which the names of albums will be inserted. An event handler on the input field calls the JavaScript function <code class="literal">listAlbums()</code> whenever a new band name is entered.
          </p>
          <p>
            There are several points to notice in the <code class="literal">listAlbums()</code> function. First, it includes a MQL query enclosed in a <span class="emphasis"><em>mqlread</em></span> query envelope expressed in JavaScript. Since JSON is a subset of JavaScript, the JavaScript representation is very close to the pure-JSON queries we've seen elsewhere. Note, however, that JavaScript allows but does not require double quotes around most property names, and they've been omitted in this example. Second, the <code class="literal">listAlbums()</code> uses the jQuery function named <code class="literal">$()</code>. This tersely-named function is the central part of the jQuery API. It is used to find elements within an HTML document and also to create new elements. The return value of <code class="literal">$()</code> is a <code class="literal">jQuery</code> object which represents one or more document element and defines useful methods for operating on those elements. Third, the code that displays the list of album names uses <code class="literal">jQuery.each()</code> to iterate through the elements of the albums array and invoke the specified function on each of the album objects.
          </p>
          <p>
            Finally, and most importantly, <code class="literal">listAlbums()</code> uses <code class="literal">jQuery.getJSON()</code> to invoke <span class="emphasis"><em>mqlread</em></span>. The first argument specifies the URL of <span class="emphasis"><em>mqlread</em></span>. The second argument specifies the names and values of the query parameters, and the third argument specifies a callback function to be invoked when the query results are ready. The only tricky detail here is that <code class="literal">jQuery.getJSON()</code> normally uses an <code class="literal">XMLHttpRequest</code>. To force it to use JSONP instead, we have to append the string "callback=?" to the URL. When it sees that string in the URL, it generates a unique JSONP callback name and inserts it into the URL in place of the question mark. The code for this <code class="literal">jQuery</code>-based album lister follows. Later, in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a> we'll see how you can perform JSONP "manually" in your own custom JavaScript library.
          </p>
          <div class="example">
            <a id="simplelist.html" name="simplelist.html"></a>
            <p class="title">
              <b>Example 4.6. simplelist.html: Listing albums with jQuery</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;script src="jquery.js"&gt;&lt;/script&gt;    &lt;!-- Ajax and DOM magic --&gt;
&lt;script src="json2.js"&gt;&lt;/script&gt;     &lt;!-- JSON.stringify() --&gt;
&lt;script&gt;                                
function listAlbums(band) {     // Display albums by the specified band.
    var envelope = {                       // The mqlread query envelope
        query : {                          // The MQL query 
            type: "/music/artist",         // Find a band
            name: band,                    // With the specified name
            album: [{                      // We want to know about albums
                name:null,                 // Return album names
                release_date:null,         // And release dates
                sort: "release_date",      // Order by release date
                "release_type!=":"single"  // Don't include singles
            }]
        }
    };

    var output = $("#output");                          // Output goes here
    output.html("&lt;h1&gt;Albums by " + band + "&lt;/h1&gt;");     // Display a title

    // Invoke mqlread and call the function below when it is done.
    // Adding callback=? to the URL makes jQuery do JSONP instead of XHR.
    jQuery.getJSON("http://api.freebase.com/api/service/mqlread?callback=?",
                   {query: JSON.stringify(envelope)},   // URL parameters
                   displayResults);                     // Callback function

    // This function is invoked when we get the result of our MQL query
    function displayResults(response) {  
        if (response.code == "/api/status/ok" &amp;&amp;        
            response.result &amp;&amp; response.result.album) { // Check for success...
            var list = $("&lt;ul&gt;");                       // Make &lt;ul&gt; tag.
            output.append(list.hide())                  // Keep it hidden
            var albums = response.result.album;         // Get albums.
            jQuery.each(albums, function() {            // Loop through albums.
                list.append($("&lt;li&gt;").html(this.name)); // Make &lt;li&gt; for each.
            });
            list.show("normal");                        // Reveal the list
        }
        else {                                          // On failure...
            output.append("Unknown band: " + band);     // Display message.
        }
    }
}
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;b&gt;Enter the name of a band: &lt;/b&gt;                     &lt;!-- Prompt for input --&gt;
&lt;input type="text" onchange="listAlbums(this.value)"&gt; &lt;!-- Get band name --&gt;
&lt;hr&gt;&lt;div id="output"&gt;&lt;/div&gt;                           &lt;!-- Display output --&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
            </div>
          </div><br class="example-break">
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="javascriptalbumlisting" name="javascriptalbumlisting"></a>4.5.2. Listing Albums and Tracks with JavaScript
                </h3>
              </div>
            </div>
          </div>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.html" title="Example 4.7. albumlist.html: a JavaScript album and track lister">Example 4.7</a> is a more complicated example than <a class="xref" href="http://mql.freebaseapps.com/ch04.html#simplelist.html" title="Example 4.6. simplelist.html: Listing albums with jQuery">Example 4.6</a>: in addition to listing albums by a band, it can also list tracks on an album. Its output is pictured in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#fig-albumlist2" title="Figure 4.1. Listing albums and tracks">Figure 4.1</a>. In addition to its more sophisticated output, it does not rely on the <span class="emphasis"><em>jQuery</em></span> library, instead performing HTML document creation and manipulation using lower-level DOM calls.
          </p>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.html" title="Example 4.7. albumlist.html: a JavaScript album and track lister">Example 4.7</a> depends on two external modules. <span class="emphasis"><em>json2.js</em></span> is the public-domain JSON parser and serializer that we used in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#simplelist.html" title="Example 4.6. simplelist.html: Listing albums with jQuery">Example 4.6</a>. The second module of external code is <span class="emphasis"><em>metaweb.js</em></span>. This module, whose code listed in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a>, defines the utility function <code class="literal">Metaweb.read()</code> that submits a MQL query, through a <code class="literal">&lt;script&gt;</code> tag, to the <span class="emphasis"><em>mqlread</em></span> service. This <code class="literal">Metaweb.read()</code> function performs its own JSONP networking without relying on <span class="emphasis"><em>jQuery</em></span>.
          </p>
          <div class="figure">
            <a id="fig-albumlist2" name="fig-albumlist2"></a>
            <p class="title">
              <b>Figure 4.1. Listing albums and tracks</b>
            </p>
            <div class="figure-contents">
              <div>
                <img alt="Listing albums and tracks" width="100%" src="./MQL Reference Guide  Chapter 4. Metaweb Read Services_files/jsalbumlist2.png">
              </div>
            </div>
          </div><br class="figure-break">
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.html" title="Example 4.7. albumlist.html: a JavaScript album and track lister">Example 4.7</a> lists the albums (it uses the <code class="literal">!=</code> constraint to exclude singles) by a specified band, and also displays the tracks on an album when the user clicks on the name of the album. There are several features worth noting in this example. First, notice that this code uses the <code class="literal">Metaweb.read()</code> function to send queries to the <span class="emphasis"><em>mqlread</em></span> service. We'll see how <code class="literal">Metaweb.read()</code> is implemented in the next section. Second, note that the code displays a "Loading..." message to the user while the queries are pending and also displays an appropriate message if a query fails. element. Finally, in addition to querying album and track names, the queries in this example also ask for album release date and track length. The example includes utility functions to massage this data, extracting a year from a <code class="literal">/type/datetime</code> string and converting a track length in seconds into the more familiar <span class="emphasis"><em>mm:ss</em></span> format.
          </p>
          <div class="example">
            <a id="albumlist.html" name="albumlist.html"></a>
            <p class="title">
              <b>Example 4.7. albumlist.html: a JavaScript album and track lister</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;script src="json2.js"&gt;&lt;/script&gt;     &lt;!-- Defines JSON.stringify() --&gt;
&lt;script src="metaweb.js"&gt;&lt;/script&gt;   &lt;!-- Defines Metaweb.read() --&gt;
&lt;script&gt;                                
/* Display albums by the specified band */
function listAlbums(band) {
    // Find the document elements we need to insert content into
    var title = document.getElementById("title");
    var albumlist = document.getElementById("albumlist");
    var tracklist = document.getElementById("tracklist");

    title.innerHTML = "Albums by " + band;           // Set the page title 
    albumlist.innerHTML = "&lt;b&gt;&lt;i&gt;Loading...&lt;/i&gt;&lt;/b&gt;" // Album list is coming...
    tracklist.style.visibility = "hidden";           // Hide any old tracks
    
    var query = {                      // This is our MQL query 
        type: "/music/artist",         // Find a band
        name: band,                    // With the specified name
        album: [{                      // We want to know about albums         
            name:null,                 // Return album names
            id:null,                   // Also ids
            release_date:null,         // And release dates
            sort: "release_date",      // Order by release date
            "release_type!=":"single"  // Don't include singles
        }]
    };

    // Issue the query and invoke the function below when it is done
    Metaweb.read(query, displayAlbums);

    // This function is invoked when we get the result of our MQL query
    function displayAlbums(result) {  
        // If no result, the band was unknown.
        if (!result || !result.album) {
            albumlist.innerHTML = "&lt;b&gt;&lt;i&gt;Unknown band: " + band + "&lt;/i&gt;&lt;/b&gt;";
            return;
        }
        
        // Otherwise, the result object matches our query object, 
        // but has album data filled in.  
        var albums = result.album;  // the array of album data
        // Erase the "Loading..." message we displayed earlier
        albumlist.innerHTML = "";
        // Loop through the albums
        for(var i = 0; i &lt; albums.length; i++) {
            var name = albums[i].name;                   // album name 
            var year = getYear(albums[i].release_date);  // album release year
            var text = name + (year?(" ["+year+"]"):""); // name+year

            // Create HTML elements to display the album name and year.
            var div = document.createElement("div");
            div.className = "album";
            div.appendChild(document.createTextNode(text));
            albumlist.appendChild(div);

            // Add an event handler to display tracks when an album is clicked
            div.onclick = makeHandler(name, albums[i].id);
        }

        // This function returns a function.  We do it this way to create
        // a closure that captures the band name and id.
        function makeHandler(name, id) {
            return function(e) { listTracks(name, id); }
        }
    }

    // A utility to return the year portion of a Metaweb /type/datetime
    function getYear(date) {
        if (!date) return null;
        if (date.length == 4) return date;
        if (date.match(/^\d{4}-/)) return date.substring(0,4);
        return null;
    }
}

/* Display the tracks on the specified album by the specified band */
function listTracks(albumname, albumid) {
    // Begin by displaying a Loading... message
    var tracklist = document.getElementById("tracklist");
    tracklist.innerHTML = "&lt;h2&gt;" + albumname + "&lt;/h2&gt;&lt;p&gt;Loading...";
    tracklist.style.visibility = "visible";

    // This is the MQL query we will issue
    var query = {
        type: "/music/album",
        id: albumid,
        // Get track names and lengths, sorted by index
        track: [{name:null, length:null, index:null, sort:"index"}]
    };

    // Issue the query, invoke the nested function when the response arrives
    Metaweb.read(query, function(result) {
                     if (result &amp;&amp; result.track) { // If result is defined
                         var tracks = result.track;  // array of tracks
                         // Build an array of track names + lengths
                         var listitems = [];
                         for(var i = 0; i &lt; tracks.length; i++) {
                             var n = tracks[i].name + " (" +
                               toMinutesAndSeconds(tracks[i].length) + ")";
                             listitems.push(n);
                         }
                         // Display the track list by setting innerHTML
                         tracklist.innerHTML = "&lt;h2&gt;" + albumname + "&lt;/h2&gt;" +
                             "&lt;ol&gt;&lt;li&gt;" + listitems.join("&lt;li&gt;") + "&lt;/ol&gt;";
                     }
                     else {
                         // If empty result display error message
                         tracklist.innerHTML = "&lt;h2&gt;" + albumname + "&lt;/h2&gt;" +
                             "&lt;p&gt;No track list is available.";
                     }
                 });

    // Convert track length in seconds to minutes:seconds format
    function toMinutesAndSeconds(seconds) {
        var minutes = Math.floor(seconds/60);
        var seconds = Math.floor(seconds-(minutes*60));
        if (seconds &lt;= 9) seconds = "0" + seconds;
        return minutes + ":" + seconds;
    }
};
&lt;/script&gt;
&lt;!-- A CSS stylesheet to make the output look nice --&gt;
&lt;style&gt; 
#albumlist { width:50%; padding: 5px; }
#tracklist {
  width: 45%; float:right; visibility:hidden;
  padding: 5px; border: solid black 2px; margin-right: 10px;
  background-color: #8a8;
}
#tracklist h2 { font: bold 16pt sans-serif;  text-align: center;}
#tracklist p { text-align: center; font: italic bold 12pt sans-serif; }
#tracklist li { font-style: italic;}
div.album {  font: bold 12pt sans-serif; margin: 2px;}
div.album:hover {text-decoration: underline;}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;!-- The HTML form in which the user can enter the name of a band --&gt;
&lt;!-- It invokes listAlbums() when the user hits Return or clicks the button --&gt;
&lt;form onsubmit="listAlbums(this.band.value); return false;"&gt;
&lt;b&gt;Enter the name of a band: &lt;/b&gt;
&lt;input type="text" name="band"&gt;
&lt;input type="submit" value="List Albums"&gt;
&lt;/form&gt;
&lt;hr&gt;
&lt;!-- This is where we insert the results of our Metaweb queries --&gt;
&lt;h1 id="title"&gt;&lt;/h1&gt;        &lt;!-- display band name here --&gt;
&lt;div id="tracklist"&gt;&lt;/div&gt;  &lt;!-- list tracks here --&gt;
&lt;div id="albumlist"&gt;&lt;/div&gt;  &lt;!-- list of albums here --&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
            </div>
          </div><br class="example-break">
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="clientmqlqueries" name="clientmqlqueries"></a>4.5.3. Client-side MQL Queries with &lt;script&gt;
                </h3>
              </div>
            </div>
          </div>
          <p>
            In this section, we develop the <code class="literal">Metaweb.read()</code> utility function used by <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.html" title="Example 4.7. albumlist.html: a JavaScript album and track lister">Example 4.7</a>. The code in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a> is short but somewhat complicated because it performs JSONP networking. The key to understanding it is to realize that each call to <code class="literal">Metaweb.read()</code> defines a function with a name like <code class="literal">Metaweb._3()</code> (the number is different on each invocation). This function does the work of processing the response from the Metaweb server. In order to get this function invoked, <code class="literal">Metaweb.read()</code> adds a <code class="literal">callback</code> parameter to the <span class="emphasis"><em>mqlread</em></span> query URL, like this:
          </p>
          <pre class="programlisting">&amp;callback=Metaweb._3
</pre>
          <p>
            When the <span class="emphasis"><em>mqlread</em></span> service is invoked with this <code class="literal">callback</code> parameter, it does not return the result as a pure JSON object. Instead it returns JavaScript code. The code is simply a function invocation of the function named by the parameter. The invocation includes a JSON object as the single argument to the function:
          </p>
          <pre class="programlisting">Metaweb._3(/* JSON object goes here */)
</pre>
          <p>
            Since JSON is a subset of the JavaScript object and array literal syntax, any JSON object is a valid function argument. By simply wrapping a function invocation around the JSON object, we've converted the <span class="emphasis"><em>mqlread</em></span> response into a form suitable for use with a <code class="literal">&lt;script&gt;</code> tag.
          </p>
          <p>
            Note that <code class="literal">Metaweb.read()</code> uses <code class="literal">JSON.stringify()</code> to serialize the query object into JSON form. This utility function is defined in the <span class="emphasis"><em>json2.js</em></span> module from <span class="emphasis"><em>http://www.JSON.org/json2.js</em></span>. The accompanying <code class="literal">JSON.parse()</code> function is not required, however, since the JavaScript interpreter that processes the <code class="literal">&lt;script&gt;</code> tag serves as our JSON parser.
          </p>
          <p>
            Once you've understood the use of the <code class="literal">callback</code> parameter, and the <code class="literal">JSON.stringify()</code> function, the other important feature to note about <code class="literal">Metaweb.read()</code> is that it can submit multiple MQL queries in a single <span class="emphasis"><em>mqlread</em></span> request. Each query must have a corresponding function to which results are passed, and you can pass any number of query/function pairs to <code class="literal">Metaweb.read()</code>.
          </p>
          <p>
            The implementation of <code class="literal">Metaweb.read()</code> shows how this is done: the function uses the <code class="literal">queries</code> parameter to <span class="emphasis"><em>mqlread</em></span> instead of the <code class="literal">query</code> parameter, and it places each individual query envelope into an outer envelope object, giving each query a name: <code class="literal">q0</code>, <code class="literal">q1</code>, and so on.
          </p>
          <div class="example">
            <a id="metaweb.js" name="metaweb.js"></a>
            <p class="title">
              <b>Example 4.8. metaweb.js: Metaweb queries with script tags</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">/**
 * metaweb.js: 
 *
 * This file implements a Metaweb.read() utility function using a &lt;script&gt;
 * tag to generate the HTTP request and the URL callback parameter to
 * route the response to a specified JavaScript function.
 **/
var Metaweb = {};                         // Define our namespace
Metaweb.HOST = "http://api.freebase.com"; // The Metaweb server
Metaweb.MQLREAD = "/api/service/mqlread"; // The mqlread service on that server

// This function submits one or more MQL queries to the mqlread service.
// When the results are available, it asynchronously passes them to 
// the specified callback functions.  The function expects an even number
// of arguments: each pair of arguments consists of a query and a 
// callback function.
Metaweb.read = function(/* q0, f0 [, q1, f1...] */) {
    // Figure out how many queries we've been passed
    if (arguments.length &lt; 2 || arguments.length % 2 == 1)
        throw "Wrong number of arguments to Metaweb.read()";
    var nqueries = arguments.length / 2;

    // Place each query in a query envelope, and put each query envelope
    // in an outer envelope.  Also, store the callbacks in an array for
    // later use.
    var envelope = {}                          // The outer envelope
    var callbacks = new Array(nqueries);       // An array to hold callbacks
    for(var i = 0; i &lt; nqueries; i++) {        // For each query/callback pair
        var inner = {"query": arguments[i*2]}; // Make inner query envelope
        var qname = "q" + i;                   // Property name for the query
        envelope[qname] = inner;               // Put inner envelope in outer
        callbacks[i] = arguments[i*2 + 1];     // Callback for the query
    }

    // Serialize and encode the envelope object.
    var serialized = JSON.stringify(envelope);    // http://json.org/json2.js
    var encoded = encodeURIComponent(serialized); // Core JavaScript function

    // Start building the URL
    var url = Metaweb.HOST + Metaweb.MQLREAD +  // Base mqlread URL
        "?queries=" + encoded;                  // Queries request parameter

    // Get a callback function name for this url
    var callbackName = Metaweb.makeCallbackName(url);

    // Add the callback parameter to the URL
    url += "&amp;callback=Metaweb." + callbackName;

    // Create the script tag that will fetch the contents of the url
    var script = document.createElement("script");

    // Define the function that will be invoked by the script tag.
    // This function expects to be passed an outer response envelope.
    // It extracts query results and passes them to the corresponding callback.
    // The function throws exceptions on errors. Since it is invoked
    // asynchronously, those exceptions can't be caught, but they will
    // appear in the browser's JavaScript console as useful diagnostics.
    Metaweb[callbackName] = function(outer) {
        // Throw an exception if there was an invocation error.
        if (outer.code != "/api/status/ok") {  // Should never happen
            var error = outer.messages[0];
            throw outer.status + ": " + error.code + ": " + error.message;
        }

        var errors = [];  // An array of error messages to be thrown later

        // For each query, get the response envelope, test for success,
        // and pass query results to the corresponding callback function.
        // If any query (or callback) fails, save an error to throw later.
        for(var i = 0; i &lt; nqueries; i++) {
            var qname = "q" + i;            // Query property name
            var inner = outer[qname];       // Extract inner envelope
            // Check for query success or failure
            if (inner.code == "/api/status/ok") {
                try {
                    callbacks[i](inner.result); // On success, call callback
                } catch(ex) {
                    // Remember any exceptions caused by the callback
                    errors.push("Exception from callback #" + i + ": " + ex);
                }
            }
            else {
                // If it failed, add all of its error messages to errors[].
                for(var j = 0; j &lt; inner.messages.length; j++) {
                    var error = inner.messages[j];
                    var msg = "mqlread error in query #" + i +
                        ": " + error.code + ": " + error.message;
                    errors.push(msg);
                }
            }
        }

        // Now perform some cleanup
        document.body.removeChild(script);   // Remove the &lt;script&gt; tag
        delete Metaweb[callbackName];        // Delete this function

        // Finally, if there were any errors, raise an exception now so they
        // at least get reported in the JavaScript console.
        if (errors.length &gt; 0) throw errors.join("\n");
    };

    // Now set the URL of the script tag and add that tag to the document.
    // This triggers the HTTP request and submits the query.
    script.src = url
    document.body.appendChild(script);
};

// This function returns a callback name that is not currently in use.
// Ideally, to support caching, the name ought to be based on the URL so the
// same URL always generates the same name.  For simplicity, however, we
// just increment a counter here.
Metaweb.makeCallbackName = function(url) {
    return "_" + Metaweb.makeCallbackName.counter++;                     
};
Metaweb.makeCallbackName.counter = 0; // Initialize the callback name counter.
</pre>
            </div>
          </div><br class="example-break">
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="id2943798" name="id2943798"></a>4.6. The Metaweb Search Service
              </h2>
            </div>
          </div>
        </div>
        <p>
          The <span class="emphasis"><em>freebase.com</em></span> website includes a search text box in the upper-right corner. Type in some text and hit return, and freebase will list database entries that match your query. While you type it offers a drop-down menu of suggestions (or auto-completions). Both the search function and the auto-complete function are powered by Metaweb's <span class="emphasis"><em>search</em></span> service. For every object in the database, the <span class="emphasis"><em>search</em></span> service indexes the name and aliases (<code class="literal">/common/topic/alias</code>) of the object, as well as any other properties of <code class="literal">/type/text</code>, and any documents associated (such as through <code class="literal">/common/topic/article</code>) with the object. Search results are ordered according to an opaque, but well-tuned ranking system to yield the most relevant results first. At the time of this writing <sup>[<a class="footnote" href="http://mql.freebaseapps.com/ch04#ftn.id2943847" id="id2943847" name="id2943847">20</a>]</sup> Metaweb's search engine is not language-aware, and indexes all text without regard to its source language.
        </p>
        <p>
          This section describes the search API so that you can use it in your own web applications. Note, however that if you simply want to duplicate on your own website the searching and drop-down suggestion functionality of <span class="emphasis"><em>freebase.com</em></span>, you should consider using the open-source <span class="emphasis"><em>freebase-suggest</em></span> library, which is available at <span class="emphasis"><em><a class="ulink" href="http://code.google.com/p/freebase-suggest/">http://code.google.com/p/freebase-suggest/</a></em></span>.
        </p>
        <p>
          Keep in mind that the <span class="emphasis"><em>search</em></span> service is a sophisticated full-text search engine that indexes Metaweb objects and the documents associated with them. Many simpler searches (such as looking for objects with particular words in their names) are best expressed as MQL queries (using the <code class="literal">~=</code> operator for pattern matching) using the <span class="emphasis"><em>mqlread</em></span> service.
        </p>
        <p>
          The <span class="emphasis"><em>search</em></span> service is a web-based service, like <code class="literal">mqlread</code>. The base URL for requesting search results from freebase.com is:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/service/search
</pre>
        <p>
          Unlike <span class="emphasis"><em>mqlread</em></span>, the <span class="emphasis"><em>search</em></span> service does not encode queries as JSON objects, and instead passes the query text and other search variables as URL parameters. For example, to search for people named "Smith", you could use this URL:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/service/search?query=Smith&amp;type=/people/person
</pre>
        <p>
          The URL parameters to <span class="emphasis"><em>search</em></span> are described in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#searchinput" title="4.6.1. Search Input">Section 4.6.1</a>. If you enter the above URL into a browser, you'll see that the <span class="emphasis"><em>search</em></span> service, like <span class="emphasis"><em>mqlread</em></span>, returns its results as a JSON object. The format of the results are covered in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#searchoutput" title="4.6.2. Search Output">Section 4.6.2</a>.
        </p>
        <p>
          The sub-sections that follow describe the input and output of the <span class="emphasis"><em>search</em></span> service and then demonstrate its use with a JavaScript example.
        </p>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="searchinput" name="searchinput"></a>4.6.1. Search Input
                </h3>
              </div>
            </div>
          </div>
          <p>
            Input to the <span class="emphasis"><em>search</em></span> service takes the form of HTML form-encoded parameters appended to the URL. There are four categories of parameters:
          </p>
          <div class="itemizedlist">
            <ul>
              <li>
                <p>
                  parameters that specify the text to be matched;
                </p>
              </li>
              <li>
                <p>
                  parameters that narrow the field of search by domain or type;
                </p>
              </li>
              <li>
                <p>
                  parameters that specify the number or offset of the desired results; and
                </p>
              </li>
              <li>
                <p>
                  parameters that affect the format of the returned results.
                </p>
              </li>
            </ul>
          </div>
          <p>
            Every invocation of the <span class="emphasis"><em>search</em></span> service must include either a <code class="literal">query</code> parameter or a <code class="literal">prefix</code> parameter (but not both). Both specify text to be searched for. If you use the <code class="literal">query</code> parameter, your text will only match complete words. If you specify <code class="literal">prefix</code>, however, any word that begins with your text matches. Searches are case-insensitive and ignore punctuation and accents on characters. The search target you specify may include multiple words, but you may not include multiple <code class="literal">query</code> or <code class="literal">prefix</code> parameters in a search URL.
          </p>
          <p>
            You can narrow the field of search (or at least change the way the <span class="emphasis"><em>search</em></span> service ranks results) with the <code class="literal">domain</code> and <code class="literal">type</code> parameters. The value of the <code class="literal">domain</code> parameter should be the id of a Metaweb domain. For example:
          </p>
          <pre class="programlisting">https://api.freebase.com/api/service/search?query=Smith&amp;domain=/film
</pre>
          <p>
            This query looks for topics that match the word Smith and have at least one type in the <code class="literal">/film</code> domain. Results might include the <code class="literal">/film/actor</code> Will Smith, and the <code class="literal">/film/film</code> "Mr. Smith Goes to Washington".
          </p>
          <p>
            It is unusual to do a domain constraint alone as in the example above. Here is an alternative (with the URL truncated to fit on one line) that looks for film-related people named Smith. It matches actors and producers, but not films:
          </p>
          <pre class="programlisting">/api/service/search?query=Smith&amp;type=/people/person&amp;domain=/film
</pre>
          <p>
            The <code class="literal">type</code> parameter specifies the id of a Metaweb type. In the search URL above, it specifies that each of the matches should be a <code class="literal">/people/person</code> object.
          </p>
          <p>
            A <span class="emphasis"><em>search</em></span> URL may include more than one <code class="literal">type</code> parameter to specify more than one type. The way that <code class="literal">type</code> parameters affect search results is controlled by the <code class="literal">type_strict</code> parameter, which must have one of the following three values:
          </p>
          <div class="variablelist">
            <dl>
              <dt>
                <span class="term"><code class="literal">all</code></span>
              </dt>
              <dd>
                <p>
                  Search results will only include objects that are members of all of the types described.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">any</code></span>
              </dt>
              <dd>
                <p>
                  Search results will only include objects that are members of at least one of the specified types. Objects that match more types will have increased relevance scores, and may appear earlier in the search results. This is the default type matching mode when no <code class="literal">type_strict</code> parameter is given.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">should</code></span>
              </dt>
              <dd>
                <p>
                  The specified types will be used in computing the relevance of the search results, but results may include objects that do not match any of the specified types.
                </p>
              </dd>
            </dl>
          </div>
          <p>
            Here are some more search URLs (abbreviated so they fit on one line) with comments indicating what they do:
          </p>
          <pre class="programlisting">// Find objects matching "Smith" that are either films or actors.
// type_strict=any is implicit in this search
search?query=Smith&amp;type=/film/film&amp;type=/film/actor

// Find objects matching "Smith" that are both films and actors.
// Results, if any, probably represent typing errors in the database.
search?query=Smith&amp;type=/film/film&amp;type=/film/actor&amp;type_strict=all

// Find objects matching "Smith"; give priority to films and actors
search?query=Smith&amp;type=/film/film&amp;type=/film/actor&amp;type_strict=should
</pre>
          <p>
            By default, the <span class="emphasis"><em>search</em></span> service returns the 20 most relevant results. You can request a different number of results with the <code class="literal">limit</code> parameter. If you want to retrieve another page of less-relevant results, you can use the <code class="literal">start</code> parameter:
          </p>
          <pre class="programlisting">search?query=Smith                   // Results 1-20
search?query=Smith&amp;limit=10          // Results 1-10
search?query=Smith&amp;start=10&amp;limit=10 // Results 11-20
</pre>
          <p>
            The final category of URL parameters are those miscellaneous parameters that affect the formatting of the results. Use <code class="literal">escape=false</code> to turn off HTML escaping of the &amp;, &lt;, and &gt; characters in the results. Use <code class="literal">indent=true</code> if you want the JSON string of search results to be pretty-printed so that it is more human-readable. This parameter is useful when experimenting with search URLs in a web browser, but is not necessary when executing searches from scripts. The search results shown in the next section are pretty-printed, even though the <code class="literal">indent</code> parameter is omitted from the search URLs.
          </p>
          <p>
            If you want to use the <span class="emphasis"><em>search</em></span> service from client-side JavaScript code, you'll need to use the <code class="literal">callback</code> parameter. This parameter enables JSONP just as it does for <span class="emphasis"><em>mqlread</em></span>: it wraps a JavaScript function invocation around the JSON result string. Using the <span class="emphasis"><em>search</em></span> service with JavaScript is demonstrated in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb2.js" title="Example 4.9. metaweb.js: searching Metaweb">Example 4.9</a> and <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.html" title="Example 4.10. albumlist2.html: Searching for bands">Example 4.10</a>.
          </p>
          <p>
            Finally, the <code class="literal">mql_output</code> parameter specifies which properties of each matching object are to appear in the search results. See <a class="xref" href="http://mql.freebaseapps.com/ch04.html#searchoutput" title="4.6.2. Search Output">Section 4.6.2</a> for details and examples.
          </p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="searchoutput" name="searchoutput"></a>4.6.2. Search Output
                </h3>
              </div>
            </div>
          </div>
          <p>
            The <span class="emphasis"><em>search</em></span> service returns a JSON-encoded envelope object just as the <span class="emphasis"><em>mqlread</em></span> service does. This object has a <code class="literal">code</code> property that specifies whether the search succeeded or failed. If this code is anything other than "/api/status/ok", then the search failed. In this case, the envelope object has a <code class="literal">messages</code> property whose value is an array of one or more message objects. The <code class="literal">messages</code> array returned by <span class="emphasis"><em>search</em></span> is just like that returned by <span class="emphasis"><em>mqlread</em></span>: each element of this array includes a <code class="literal">code</code> property that identifies the specific kind of error and a <code class="literal">message</code> property that can be used to generate a diagnostic message. Certain message <code class="literal">code</code> values also have an associated <code class="literal">info</code> property that provides error details, but the list of codes and the format of their associated info objects is not documented.
          </p>
          <p>
            If you get an error from the <span class="emphasis"><em>search</em></span> service, it typically means that you invoked it incorrectly. Errors can occur if (for example) you don't specify either the <code class="literal">query</code> or <code class="literal">prefix</code> parameter, or if you specify an illegal value for the <code class="literal">type_strict</code> parameter, or if you specify an undefined id as the value of the <code class="literal">type</code> or <code class="literal">domain</code> parameter. If a search URL is properly constructed, the search is considered a success, even if it matches nothing and returns no results.
          </p>
          <p>
            If the <code class="literal">code</code> property of the envelope object is "/api/status/ok", then the query was a success, and the envelope has a <code class="literal">result</code> property that holds a (possibly empty) array of search results.
          </p>
          <p>
            The following search URL, for example:
          </p>
          <pre class="programlisting">https://api.freebase.com/api/service/search?query=Smith&amp;limit=1
</pre>
          <p>
            might return these results:
          </p>
          <pre class="programlisting">{
  "status": "200 OK", 
  "code": "/api/status/ok", 
  "transaction_id":"cache;cache01.p01.sjc1:8101;2008-09-16T21:47:14Z;0006",
  "result": [
    {
      "id": "/guid/9202a8c04000641f80000000004f16a0",
      "name": "William Smith", 
      "alias": [], 
      "type": [
        { "id": "/common/topic", "name": "Topic" }, 
        { "id": "/people/person", "name": "Person" }, 
        { "id": "/people/deceased_person", "name": "Deceased Person" }
      ], 
      "article": { "id": "/guid/9202a8c04000641f80000000004f16a5" }, 
      "image": null
    }
  ]
}
</pre>
          <p>
            The envelope object includes <code class="literal">status</code>, <code class="literal">code</code> and <code class="literal">transaction_id</code> properties just <span class="emphasis"><em>mqlread</em></span> response envelopes do. The interesting part of the envelope object is the <code class="literal">result</code> array. For this example query, we explicitly specified a <code class="literal">limit</code> of 1, so the array has only one element, but in general each element of the <code class="literal">result</code> array provides information about a single Metaweb object that matched the search query. By default (if you do not specify a <code class="literal">mql_output</code> parameter in the search query), each element is an object with the following properties:
          </p>
          <div class="variablelist">
            <dl>
              <dt>
                <span class="term"><code class="literal">id</code></span>
              </dt>
              <dd>
                <p>
                  The Metaweb id of the matched object.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">name</code></span>
              </dt>
              <dd>
                <p>
                  The name of the matched object. (At the time of this writing, <sup>[<a class="footnote" href="http://mql.freebaseapps.com/ch04#ftn.id2963010" id="id2963010" name="id2963010">21</a>]</sup> there is no way to specify the preferred language in which the name should be returned.)
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">alias</code></span>
              </dt>
              <dd>
                <p>
                  An array of nicknames for the object. These are the values of the <code class="literal">/common/topic/alias</code> property.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">type</code></span>
              </dt>
              <dd>
                <p>
                  An array that specifies the types of the object. Each element of this array is an object with <code class="literal">id</code> and <code class="literal">name</code> properties that specify the Metaweb id and the human-readable name of the type.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">article</code></span>
              </dt>
              <dd>
                <p>
                  If the matched object has at least one associated document as the value of the <code class="literal">/common/topic/article</code> property, then this result property refers to an object with a single <code class="literal">id</code> property. This <code class="literal">article.id</code> property is the Metaweb id of the most recent document associated with the object. A blurb from this article can be a useful addition to search results. (<a class="xref" href="http://mql.freebaseapps.com/ch04.html#transservice" title="4.7. Fetching Content with trans">Section 4.7</a> shows how to retrieve article blurbs.) If the matched object has no associated documents, then this property is <code class="literal">null</code>.
                </p>
              </dd>
              <dt>
                <span class="term"><code class="literal">image</code></span>
              </dt>
              <dd>
                <p>
                  If the matched object has at least one associated image as the value of the <code class="literal">/common/topic/image</code> property, then this property refers to an object with nothing but an <code class="literal">id</code> property. <code class="literal">image.id</code> is a Metaweb id of the first image (the image with <code class="literal">index:0</code>, see <a class="xref" href="http://mql.freebaseapps.com/ch03.html#orderedcollections" title="3.5.4. Ordered Collections">Section 3.5.4</a>). It may be useful to include a thumbnail of this image in a listing of search results. (<a class="xref" href="http://mql.freebaseapps.com/ch04.html#transservice" title="4.7. Fetching Content with trans">Section 4.7</a> shows how to retrieve image thumbnails.) If the matched object has no associated images, then this <code class="literal">image</code> property is <code class="literal">null</code>.
                </p>
              </dd>
            </dl>
          </div>
          <p>
            These default properties of the elements of the <code class="literal">results</code> array can be overridden with the <code class="literal">mql_output</code> URL parameter. The value of this parameter should be a MQL query in square brackets. The <span class="emphasis"><em>search</em></span> service adds the following properties to the query you specify:
          </p>
          <pre class="programlisting">"guid": null
"guid|=": [guids of all matching objects here]
</pre>
          <p>
            The <code class="literal">guid|=</code> property specifies the guids of all objects that matched the search. The query is passed to <span class="emphasis"><em>mqlread</em></span>, and the results become the <code class="literal">results</code> array of the search. Consider this query (which wraps onto two lines), for example:
          </p>
          <pre class="programlisting">https://api.freebase.com/api/service/search?query=love&amp;type=/music/track&amp;limit=3
&amp;mql_output=[{"name":null,"/music/track/artist":null}]
</pre>
          <p>
            It returns results like these:
          </p>
          <pre class="programlisting">{
  "status": "200 OK",
  "code": "/api/status/ok",
  "transaction_id":"cache;cache01.sandbox.sjc1:8101;2008-09-16T23:13:07Z;0001",
  "result": [{
    "guid" : "#9202a8c04000641f8000000001268f44",
    "name" : "Tainted Love",
    "/music/track/artist" : "Soft Cell"
  },{
    "guid" : "#9202a8c04000641f80000000012b0704",
    "name" : "Endless Love",
    "/music/track/artist" : "Diana Ross &amp;amp; Lionel Richie"
  },{
    "guid" : "#9202a8c04000641f800000000129a206",
    "name" : "The Power of Love",
    "/music/track/artist" : "Huey Lewis &amp;amp; the News"
  }]
}
</pre>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="id2963231" name="id2963231"></a>4.6.3. Example: Searching for Band Names
                </h3>
              </div>
            </div>
          </div>
          <p>
            To demonstrate the <span class="emphasis"><em>search</em></span> service, let's extend the <span class="emphasis"><em>metaweb.js</em></span> module of <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a>. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb2.js" title="Example 4.9. metaweb.js: searching Metaweb">Example 4.9</a> defines a JavaScript function named <code class="literal">Metaweb.search()</code> that invokes the <span class="emphasis"><em>search</em></span> service. The code in this example is intended as an extension of <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a>. It depends on the <code class="literal">Metaweb</code> object, <code class="literal">Metaweb.HOST</code> constant and <code class="literal">Metaweb.makeCallbackName()</code> function defined in that previous example.
          </p>
          <div class="example">
            <a id="metaweb2.js" name="metaweb2.js"></a>
            <p class="title">
              <b>Example 4.9. metaweb.js: searching Metaweb</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">Metaweb.SEARCH = "/api/service/search";  // URL path to the search service

// Invoke the Metaweb search service for the specified query.
// Asynchronously pass the array of results to the specified callback function.
// 
// The first argument can be a string for simple searches or an object
// for more complex searches.  If it is a string, it should take the form
//    [type:]text[*]
// That is: the text to be searched for, optionally prefixed by a type id
// and a colon and optionally suffixed with an asterisk.  Specifying a type 
// sets the type parameter for the search, and adding an asterisk makes it a 
// prefix search.
//
// If query argument is an object, then its properties are translated into 
// search parameters.  In this case, the object must include either 
// a property named query (for an exact match) or a property named prefix
// (for a prefix match).  Other legal properties are the same as the 
// allowed parameters for the search service: type, type_strict, domain, 
// limit, start, and so on.  To specify multiple types, set the 
// type property to an array of type ids.  To specify a single type, set
// the type property to a single id.
Metaweb.search = function(query, callback) {
    var q = {};  // The query object

    if (typeof query == "string") {
        // If the query argument is a string, we must convert it to an object.
        // First, see if there is a type prefix
        var colon = query.indexOf(':');
        if (colon != -1) {
            q.type = query.substring(0, colon);
            query = query.substring(colon + 1);
        }

        // Next see if there is an asterisk suffix
        if (query.charAt(query.length-1) == '*') // prefix match
            q.prefix = query.substring(0, query.length-1);
        else
            q.query = query;
    }
    else { 
        // Otherwise, assume the query argument is an object and 
        // copy its properties into the q object.
        for(var p in query) q[p] = query[p];
    }

    // With mqlread, we would JSON-encode the query object q.  For the search
    // service, we convert the properties of q to an array of URL parameters
    var parameters = [];
    for(var name in q) {
        var value = q[name];

        if (typeof value != "object") { // A single value for the parameter
            var param = name + "=" + encodeURIComponent(value.toString());
            parameters.push(param);
        }
        else { // Otherwise, there is an array of values: multiple types
            for(var index in value) {
                var elt = value[index];
                var param = name + "=" + encodeURIComponent(elt.toString());
                parameters.push(param);
            }
        }
    }

    // Now convert the array of parameters into a URL 
    var url = Metaweb.HOST + Metaweb.SEARCH + "?" + parameters.join('&amp;');

    // Generate a name for the function that will receive the results
    var cb = Metaweb.makeCallbackName(url);

    // Add the JSONP callback parameter to the url
    url += "&amp;callback=Metaweb." + cb;

    // Create the script tag that will fetch that URL
    var script = document.createElement("script");

    // Define the function that handles the results from that URL
    Metaweb[cb] = function(envelope) {
        // Clean up by erasing this function and deleting the script tag
        document.body.removeChild(script);
        delete Metaweb[cb];

        // If the query was successful, pass results to the callback
        // Otherwise, throw an error message
        if (envelope.code == "/api/status/ok")
            callback(envelope.result);
        else {
            throw "Metaweb.search: " + envelope.messages[0].code +
                ": " + envelope.messages[0].message;
        }
    }

    // Now set the URL of the script tag and add that tag to the document.
    // This triggers the HTTP request and submits the search query.
    script.src = url
    document.body.appendChild(script);
};
</pre>
            </div>
          </div><br class="example-break">
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.html" title="Example 4.10. albumlist2.html: Searching for bands">Example 4.10</a> demonstrates how this <code class="literal">Metaweb.search()</code> function might be used in practice. It is a new version of the JavaScript-based album listing application shown in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist.html" title="Example 4.7. albumlist.html: a JavaScript album and track lister">Example 4.7</a>. The relevant new feature of this version is that if the user enters a name that is not a known band name, the application uses that name a in a search query and lists the results. For brevity, the album-listing features of this new version have been simplified, and the track-listing features have been removed.
          </p>
          <div class="example">
            <a id="albumlist2.html" name="albumlist2.html"></a>
            <p class="title">
              <b>Example 4.10. albumlist2.html: Searching for bands</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;script src="json2.js"&gt;&lt;/script&gt;     &lt;!-- Defines JSON.stringify() --&gt;
&lt;script src="metaweb.js"&gt;&lt;/script&gt;   &lt;!-- Defines Metaweb.read() --&gt;
&lt;script&gt;                                
/* Display albums by the specified band */
function listAlbums(band) {
    // Find the document elements we need to insert content into
    var title = document.getElementById("title");
    var albumlist = document.getElementById("albumlist");

    var query = [{             // This is our simple MQL query 
        type: "/music/artist", // Find a band
        name: band,            // With the specified name
        album: []              // And return all album names       
    }];

    // Issue the query and invoke the function below when it is done
    Metaweb.read(query, function(result) {  
        // If no result, the band was unknown, so search for matches
        if (!result || result.length == 0) searchForBands(band);
        // Otherwise, we found a band, so list its albums
        else {
            
            title.innerHTML = "Albums by " + band; // Display title      
            if (result[0].album.length == 0)       // If no albums, say so
                albumlist.innerHTML = "No albums found.";
            else                                   // Display the list
                albumlist.innerHTML = result[0].album.join("&lt;br&gt;");
        }
    });
}

// Find names of bands matching the user's partial input
function searchForBands(band) {
    // The Metaweb.search function will translate this object into
    // URL parameters for the search service.
    var query = { 
        prefix: band,            // Prefix search
        type: "/music/artist",   // for bands (using default type_strict:all)
    };

    Metaweb.search(query, function(results) {
        // If the search returns no results then we don't know what band
        if (results.length == 0) {
            document.getElementById("title").innerHTML = "Unknown Band"
            document.getElementById("albumlist").innerHTML = "";
        }
        // Otherwise, display a list of links to possible bands
        else {
            document.getElementById("title").innerHTML = "Do you mean..."
            var links = new Array(results.length);
            for(var i = 0; i &lt; results.length; i++) {        // For each result
                var band = results[i].name;                  // Get band name
                links[i] = '&lt;a href="javascript:listAlbums(\'' + // make link
                           band.replace("'","\\'") + '\')"&gt;' +
                           band + '&lt;/a&gt;';
            }
            // Output list of links
            document.getElementById("albumlist").innerHTML=links.join("&lt;br&gt;");
        }
    });
}
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;!-- The HTML form for entering a band name --&gt;
&lt;form onsubmit="listAlbums(this.band.value); return false;"&gt;
&lt;b&gt;Enter the name of a band: &lt;/b&gt;
&lt;input type="text" name="band"&gt;
&lt;input type="submit" value="List Albums"&gt;
&lt;/form&gt;
&lt;hr&gt;
&lt;!-- This is where we insert the results of our Metaweb queries --&gt;
&lt;h1 id="title"&gt;&lt;/h1&gt;        &lt;!-- display band name here --&gt;
&lt;div id="albumlist"&gt;&lt;/div&gt;  &lt;!-- list of albums here --&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
            </div>
          </div><br class="example-break">
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="transservice" name="transservice"></a>4.7. Fetching Content with trans
              </h2>
            </div>
          </div>
        </div>
        <p>
          As explained in <a class="xref" href="http://mql.freebaseapps.com/ch02.html" title="Chapter 2. Metaweb Architecture">Chapter 2</a>, Metaweb is really two databases in one. One database is the graph of nodes and relationships. The second is the content store that holds chunks (or "blobs") of data such as HTML documents and graphical images. We use <span class="emphasis"><em>mqlread</em></span> service to retrieve data from the graph, and we use the <span class="emphasis"><em>trans</em></span> service to retrieve content from the content store.
        </p>
        <p>
          The <span class="emphasis"><em>trans</em></span> service is so named because in addition to fetching the requested data, it can also <span class="emphasis"><em>translate</em></span> it for you. For example, it can "translate" an image to thumbnail size.
        </p>
        <p>
          The <span class="emphasis"><em>trans</em></span> service is HTTP based, just as <span class="emphasis"><em>mqlread</em></span> is. Content is retrieved by specifying the desired translation and the content id, with a URL of this form:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/trans/<span class="emphasis"><em>translation</em></span>/<span class="emphasis"><em>id</em></span>
</pre>
        <p>
          Here, for example, is an actual <span class="emphasis"><em>trans</em></span> URL:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/trans/raw/guid/9202a8c04000641f8000000003c1978c
</pre>
        <p>
          The <span class="emphasis"><em>translation</em></span> portion of a <span class="emphasis"><em>trans</em></span> URL must be one of the following:
        </p>
        <div class="variablelist">
          <dl>
            <dt>
              <span class="term"><code class="literal">raw</code></span>
            </dt>
            <dd>
              <p>
                Use <code class="literal">raw</code> to request that no translation is to be done on the data: it should be returned as is. (Note, however that HTML content is not completely raw: it is "sanitized" by stripping executable content such as JavaScript.)
              </p>
            </dd>
            <dt>
              <span class="term"><code class="literal">image_thumb</code></span>
            </dt>
            <dd>
              <p>
                Use <code class="literal">image_thumb</code> to request a thumbnail-sized version of an image. You can add request parameters <code class="literal">maxwidth</code> and <code class="literal">maxheight</code> to the URL to specify the desired pixel dimensions of the thumbnail. The aspect ratio of the original image is always preserved, and, by default, the image is not cropped, so if you specify both <code class="literal">maxwidth</code> and <code class="literal">maxheight</code>, the resulting image will typically match only one of those dimensions. The default value of both parameters is 75.
              </p>
              <p>
                If you want to specify the exact size of both dimensions of the thumbnail, add <code class="literal">mode=fillcrop</code> to the URL: this will cause one dimension to be cropped as necessary, while still preserving the image's aspect ratio.
              </p>
            </dd>
            <dt>
              <span class="term"><code class="literal">blurb</code></span>
            </dt>
            <dd>
              <p>
                Use <code class="literal">blurb</code> to request an excerpt of document content. This provides a kind of a preview, of the kind you might see in a list of search results. In HTML documents, only content within <code class="literal">&lt;p&gt;</code> tags is returned, and all HTML tags are normally stripped. The default blurb length is 200 bytes, but you can alter this with the <code class="literal">maxlength</code> request parameter. If a blurb spans multiple paragraphs, the paragraph breaks are usually removed (along with other HTML tags). Add the request parameter <code class="literal">break_paragraphs=true</code> to preserve HTML paragraph breaks in the blurb.
              </p>
            </dd>
          </dl>
        </div>
        <p>
          The path component that follows the <span class="emphasis"><em>translation</em></span> is a Metaweb id. The id passed to <span class="emphasis"><em>trans</em></span> must identify an object of type <code class="literal">/type/content</code>, <code class="literal">/common/image</code> or <code class="literal">/common/document</code>. These three types are closely related:
        </p>
        <div class="variablelist">
          <dl>
            <dt>
              <span class="term"><code class="literal">/type/content</code></span>
            </dt>
            <dd>
              <p>
                A <code class="literal">/type/content</code> object is the representation in the Metaweb graph of an entry in the Metaweb content store.
              </p>
            </dd>
            <dt>
              <span class="term"><code class="literal">/common/image</code></span>
            </dt>
            <dd>
              <p>
                When an image is added to the content store, the <code class="literal">/type/content</code> object for the image is co-typed <code class="literal">/common/image</code>, in order to add a <code class="literal">size</code> property that supplies the image dimensions. For images, therefore, the <code class="literal">id</code> of the <code class="literal">/type/content</code> and <code class="literal">/common/image</code> objects are the same.
              </p>
            </dd>
            <dt>
              <span class="term"><code class="literal">/common/document</code></span>
            </dt>
            <dd>
              <p>
                When document content is added to the content store, a <code class="literal">/type/content</code> object is created to represent the entry in the content store. Typically a separate <code class="literal">/common/document</code> object is also created. The <code class="literal">content</code> property of the document object refers to the content object. Other properties of the <code class="literal">/common/document</code> object provide additional meta-information about the document. The reason that <code class="literal">/common/document</code> and <code class="literal">/type/content</code> are separate objects in this case (instead of just one object with two types) is for versioning: the <code class="literal">content</code> property of the <code class="literal">/common/document</code> can easily be updated to refer to a different <code class="literal">/type/content</code> object when the document changes.
              </p>
              <p>
                <code class="literal">/common/document</code> objects can also represent Wikipedia document content (which is not stored in the Metaweb content store). Documents that represent Wikipedia entries have <code class="literal">content</code> properties of <code class="literal">null</code> (and have a key in the <code class="literal">/wikipedia/en_id</code> namespace that defines the Wikipedia id of the document).
              </p>
              <p>
                The <span class="emphasis"><em>trans</em></span> service works with both Wikipedia and non-Wikipedia documents. For non-Wikipedia documents, you can use either the id of the <code class="literal">/common/document</code> object or of the <code class="literal">/type/content</code> object it refers to.
              </p>
            </dd>
          </dl>
        </div>
        <p>
          The following MQL query asks Metaweb for the ids of documents and images related to our favorite band, The Police:
        </p>
        <div class="informaltable">
          <table border="1">
            <colgroup>
              <col>
              <col>
            </colgroup>
            <thead>
              <tr>
                <th>
                  Query
                </th>
                <th>
                  Result
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <pre class="programlisting">{
  "id": "/en/the_police",
  "type":"/common/topic",
  "article":[{"id":null}],
  "image":[{"id":null}]
}
</pre>
                </td>
                <td>
                  <pre class="programlisting">{
  "id" : "/en/the_police",
  "type" : "/common/topic",
  "article" : [{
    "id" : "/guid/9202a8c04000641f800000000006df25"
  }],
  "image" : [{
    "id" : "/wikipedia/images/en_id/982873"
  },{
    "id" : "/wikipedia/images/commons_id/3520500"
  }],
}
</pre>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p>
          Given these results, we can retrieve the document and the first image with these URLs:
        </p>
        <pre class="programlisting">https://api.freebase.com/api/trans/raw/guid/9202a8c04000641f800000000006df25
https://api.freebase.com/api/trans/raw/wikipedia/images/en_id/982873
</pre>
        <p>
          And the following URLs (truncated on the left so they fit on a line) retrieve a short blurb and a big thumbnail:
        </p>
        <pre class="programlisting">/api/trans/blurb/guid/9202a8c04000641f800000000006df25?maxlength=20
/api/trans/image_thumb/wikipedia/images/en_id/982873?maxwidth=200&amp;maxheight=200
</pre>
        <p>
          In web applications it is often easiest to use the <span class="emphasis"><em>trans</em></span> service with <code class="literal">&lt;img&gt;</code> and <code class="literal">&lt;iframe&gt;</code> tags. To retrieve and display an image, simply use a <span class="emphasis"><em>trans</em></span> URL as the <code class="literal">src</code> attribute of an <code class="literal">&lt;img&gt;</code> tag. And to retrieve and display the HTML content of a document, use a <span class="emphasis"><em>trans</em></span> URL as the <code class="literal">src</code> attribute of an <code class="literal">&lt;iframe&gt;</code> or the <code class="literal">href</code> attribute of a hyperlink.
        </p>
        <p>
          It is also possible, of course, for scripts to download the content of <span class="emphasis"><em>trans</em></span> URLs themselves, and process document or image content in whatever way they want. In JavaScript code, the <span class="emphasis"><em>trans</em></span> service can be used with a <code class="literal">callback</code> parameter just like the <span class="emphasis"><em>mqlread</em></span> and <span class="emphasis"><em>search</em></span> services can be. The sub-sections that follow extend our <span class="emphasis"><em>metaweb.js</em></span> module to add functions for invoking the <span class="emphasis"><em>trans</em></span> service. The module code is followed by two examples. One uses <span class="emphasis"><em>trans</em></span> with images, iframes and hyperlinks. The other uses the <code class="literal">callback</code> parameter to the <span class="emphasis"><em>trans</em></span> service and actually downloads document content directly.
        </p>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="id2964047" name="id2964047"></a>4.7.1. JavaScript Functions for Downloading Content
                </h3>
              </div>
            </div>
          </div>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb3.js" title="Example 4.11. metaweb.js: an extension for the trans service">Example 4.11</a> is JavaScript code that extends our <span class="emphasis"><em>metaweb.js</em></span> module to handle the <span class="emphasis"><em>trans</em></span> family of services. Three simple functions, <code class="literal">Metaweb.contentURL()</code>, <code class="literal">Metaweb.blurbURL()</code>, and <code class="literal">Metaweb.thumbnailURL()</code> accept an object id and return the a URL for fetching the specified content. The <code class="literal">blurbURL</code> function accepts optional length and paragraph breaking arguments and the <code class="literal">thumbnailURL</code> function accepts optional width and height arguments. Both encode these arguments into the returned URL. These URL functions will be demonstrated in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#WhatsNew.html" title="Example 4.12. WhatsNew.html: fetching new images and documents from freebase.com">Example 4.12</a>.
          </p>
          <p>
            The <code class="literal">Metaweb.download()</code> function is more interesting. It uses the <code class="literal">callback</code> parameter and a dynamically generated script tag to asynchronously download document content (or a document blurb) and pass it to a specified function (or insert it into a specified document element). This allows document content to be inserted directly into a document rather than isolated in a separate <code class="literal">&lt;iframe&gt;</code>. <code class="literal">Metaweb.download()</code> is demonstrated in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#TypeBrowser.html" title="Example 4.13. TypeBrowser.html: a Metaweb type browser">Example 4.13</a>.
          </p>
          <p>
            The code in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb3.js" title="Example 4.11. metaweb.js: an extension for the trans service">Example 4.11</a> is an extension to the <span class="emphasis"><em>metaweb.js</em></span> module of <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a>, and <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb2.js" title="Example 4.9. metaweb.js: searching Metaweb">Example 4.9</a> and is intended to be appended to those previous examples. The code shown here assumes that <code class="literal">Metaweb</code>, <code class="literal">Metaweb.HOST</code> and <code class="literal">Metaweb.makeCallbackName()</code> are already defined.
          </p>
          <div class="example">
            <a id="metaweb3.js" name="metaweb3.js"></a>
            <p class="title">
              <b>Example 4.11. metaweb.js: an extension for the trans service</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">Metaweb.RAW = "/api/trans/raw";
Metaweb.BLURB = "/api/trans/blurb";
Metaweb.THUMB = "/api/trans/image_thumb";

// Return a URL for fetching the content specified by id.
// This id must identify a /type/content object, or a /common/document or
// /common/image.  The returned URL is suitable for use as the value of
// the src attribute of &lt;iframe&gt; or &lt;img&gt; or the href attribute of &lt;a&gt;.
Metaweb.contentURL = function(id) {
    return Metaweb.HOST + Metaweb.RAW + id;
};

// Return the URL of an excerpt or "blurb" of the document specified by id.
// The maxlen argument specifies the length of the blurb. If maxlen is
// omitted, the default is 200. If the document is an HTML document, then only
// content within &lt;p&gt; tags is returned.  Normally all HTML tags are stripped
// from the returned blurb, making it plain text.  For long blurbs, this can
// cause paragraphs to run together. Pass true as the third argument to retain
// &lt;p&gt; tags (but strip all others) in the returned blurb.
Metaweb.blurbURL = function(id, maxlen, paragraphs) {
    var url = Metaweb.HOST + Metaweb.BLURB + id;     // Base url
    if (maxlen) url += '?maxlength=' + maxlen;       // Specify blurb length
    if (paragraphs) url += '&amp;break_paragraphs=true'; // Include &lt;p&gt; tags
    return url;
};

// Return the URL of a scaled-down version of the image specified by id.
// The thumbnail always preserves the aspect ratio of the original image.
// Specify the maximum width and height of the image with the maxwidth and
// maxheight arguments.  The defaults for both are 75, meaning that the
// thumbnail will have one dimension equal to 75 and the other less than or
// equal to 75.
Metaweb.thumbnailURL = function(id, maxwidth, maxheight) {
    var url = Metaweb.HOST + Metaweb.THUMB + id;
    if (maxwidth) url += '?maxwidth=' + maxwidth;
    if (maxheight) url += '&amp;maxheight=' + maxheight;
    return url;
}

// Download the /common/document or /type/content with id specified by from.
// If the argument to is a function, pass the document content, content type
// and encoding to the function.  Otherwise, if to is a DOM element or a 
// string that identifies a DOM element insert the content into that element.
// The third argument is optional. If specified, it should be the length
// of the desired excerpt to be downloaded with /api/trans/blurb.
Metaweb.download = function(from, to, maxlen) {
    // What service are we using?
    var service = maxlen ? "/api/trans/blurb" : "/api/trans/raw";

    // This is the URL we must request with a script tag.
    var url = Metaweb.HOST + service + from;

    // Obtain a unique name for the function to receive the download.
    var cb = Metaweb.makeCallbackName(url);

    // Add the JSONP callback parameter to the URL
    url += "?callback=Metaweb." + cb;

    // Add the maxlength argument for blurbs.
    if (maxlen &amp;&amp; typeof maxlen == "number") url += "&amp;maxlength=" + maxlen;

    // Create the script tag that will do the download for us.
    var script = document.createElement("script");

    // Define the uniquely-named function that receives the response.
    Metaweb[cb] = function(envelope) {
        // Clean up this function and the script tag.
        document.body.removeChild(script);   // Remove the &lt;script&gt; tag.
        delete Metaweb[cb];                  // Delete this function.

        // If there was an error, throw an error message
        if (envelope.code != "/api/status/ok") {
            var err = envelope.messages[0];
            throw "Metaweb.download: " + envelope.status + ": " +
              err.code + ": " + err.message;
        }
        
        // Otherwise, get the results
        var doc = envelope.result;

        // Now handle the content we've downloaded based on the type of to.
        switch(typeof to) {
        case "function":  // Pass content to a function.
            to(doc.body, doc.media_type, doc.text_encoding);
            break;
        case "string":    // Treat string as element id.
            document.getElementById(to).innerHTML = doc.body;
            break;
        case "object":    // Assume to is a DOM element.
            to.innerHTML = doc.body;
            break;
        }
    }

    // Now set the URL of the script tag and add that tag to the document.
    // This triggers the HTTP request and invokes the trans service.
    script.src = url;
    document.body.appendChild(script);
}
</pre>
            </div>
          </div><br class="example-break">
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="freebaserecentchanges" name="freebaserecentchanges"></a>4.7.2. Example: What's New on freebase.com
                </h3>
              </div>
            </div>
          </div>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#WhatsNew.html" title="Example 4.12. WhatsNew.html: fetching new images and documents from freebase.com">Example 4.12</a> is a JavaScript-based example that displays recently-added content from freebase.com. It issues <span class="emphasis"><em>mqlread</em></span> queries to find the five images and five documents most recently added to <span class="emphasis"><em>freebase.com</em></span>. (It takes advantage of the fact that the <code class="literal">Metaweb.read()</code> function defined in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb.js" title="Example 4.8. metaweb.js: Metaweb queries with script tags">Example 4.8</a> can issue multiple queries at the same time.) It then dynamically generates <code class="literal">&lt;img&gt;</code> and <code class="literal">&lt;iframe&gt;</code> tags to display image thumbnails and document blurbs, and uses the <code class="literal">Metaweb.thumbnailURL()</code> and <code class="literal">Metaweb.blurbURL()</code> functions defined in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb3.js" title="Example 4.11. metaweb.js: an extension for the trans service">Example 4.11</a> to create URLs for the <code class="literal">src</code> attributes of those tags. It also creates <code class="literal">&lt;a&gt;</code> tags, and uses <code class="literal">Metaweb.contentURL()</code> to hyperlink to full-sized versions of the images and documents. (These links open new windows to display the image or document.)
          </p>
          <div class="example">
            <a id="WhatsNew.html" name="WhatsNew.html"></a>
            <p class="title">
              <b>Example 4.12. WhatsNew.html: fetching new images and documents from freebase.com</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;script src="json2.js"&gt;&lt;/script&gt;    &lt;!-- Required by metaweb.js --&gt;
&lt;script src="metaweb.js"&gt;&lt;/script&gt;  &lt;!-- Defines Metaweb.read(), etc. --&gt;
&lt;script&gt;
// How many images and how many documents do we display?
var N = 5;                                           // This is the default
if (window.location.search.substring(0,3) == "?n=")  // URL argument overrides
    N = parseInt(window.location.search.substring(3));

// The query to find the N newest images
var imageQuery = [{
    type:"/common/image", id:null,         // Return image ids
    timestamp:null, sort:"-timestamp",     // Most recent first
    limit:N,                               // Only N of them
    "/type/content/media_type":null,       // Check image type, too
    "/type/content/media_type|=":[         // We only want images that are:
        "/media_type/image/gif",             // GIF or
        "/media_type/image/png",             // PNG or 
        "/media_type/image/jpeg"             // JPEG
        ]
}];

// The query to find the N newest documents
var documentQuery = [{
    type:"/common/document", id:null,    // Return document ids
    timestamp:null, sort:"-timestamp",   // Most recent first
    limit:N                              // Only N of them
}];

// When the document has loaded, send the queries above to api.freebase.com.
// This will invoke the functions below when the results arrive.
window.onload = function() { 
    Metaweb.read(imageQuery, displayImages,
                 documentQuery, displayDocuments); 
};

// This function is invoked with the results of the image query.
function displayImages(images) {
    var container=document.getElementById("images"); // Get container element.
    for(var i = 0; i &lt; images.length; i++) {         // Loop through images.
        var id = images[i].id;                       // Get the image id.
        var img = document.createElement("img");     // Create &lt;img&gt; tag 
        img.src = Metaweb.thumbnailURL(id);          // ...for image thumbnail
        img.title = images[i].timestamp;             // ...timestamp tooltip.
        var link = document.createElement("a");      // Create hyperlink
        link.href = Metaweb.contentURL(id);          // ...to a full-size image
        link.target = "_new";                        // ...in new window.
        link.appendChild(img);                       // Put image in link.
        container.appendChild(link);                 // Put link in container.
    }
}

// This function is invoked with the results of the document query.
function displayDocuments(docs) {
    container = document.getElementById("docs");     // Get container element.
    for(var i = 0; i &lt; docs.length; i++) {           // Loop through docs.
        var id = docs[i].id;                         // Get the document id.
        var blurb =document.createElement("iframe"); // Create an iframe
        blurb.src = Metaweb.blurbURL(id);            // ...to hold doc blurb.
        var link = document.createElement("a");      // Hyperlink
        link.href = Metaweb.contentURL(id);          // ...to full document
        link.target = "_new";                        // ...in a new window.
        link.innerHTML = docs[i].timestamp;          // Use timestamp as link.
        var listitem = document.createElement("li"); // Create list item.
        listitem.appendChild(blurb);                 // Put blurb in item.
        listitem.appendChild(link);                  // Put link in item.
        container.appendChild(listitem);             // Put item in container.
    }
}
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;&lt;!--Static document body. Thumbnails and blurbs dynamically inserted--&gt;
  &lt;h2&gt;The Newest Images&lt;/h2&gt;                  &lt;!-- Images heading --&gt;
  &lt;i&gt;Click thumbnail for full-size image&lt;/i&gt;  &lt;!-- Instructions --&gt;
  &lt;div id="images"&gt;&lt;/div&gt;                     &lt;!-- Thumbnails will go here --&gt;
  &lt;h2&gt;The Newest Documents&lt;/h2&gt;               &lt;!-- Documents heading --&gt;
  &lt;i&gt;Click timestamp for full document&lt;/i&gt;    &lt;!-- Instructions --&gt;
  &lt;ol id="docs"&gt;&lt;/ol&gt;                         &lt;!-- Document blurbs go here --&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
            </div>
          </div><br class="example-break">
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">
                  <a id="freebasetypebrowser" name="freebasetypebrowser"></a>4.7.3. Example: A Metaweb Type Browser
                </h3>
              </div>
            </div>
          </div>
          <p>
            <a class="xref" href="http://mql.freebaseapps.com/ch04.html#TypeBrowser.html" title="Example 4.13. TypeBrowser.html: a Metaweb type browser">Example 4.13</a> is a JavaScript-based web application that demonstrates the <code class="literal">Metaweb.download()</code> function defined in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb3.js" title="Example 4.11. metaweb.js: an extension for the trans service">Example 4.11</a>. This application is a Metaweb type browser that displays information about any Metaweb type. <a class="xref" href="http://mql.freebaseapps.com/ch04.html#fig-types.html" title="Figure 4.2. A Metaweb type browser">Figure 4.2</a> shows a sample page. Clicking on the id of another type (or typing a type id in the upper right) displays information about that type. You may actually find this type browser quite useful for exploring Metaweb system types and the types in other domains.
          </p>
          <div class="figure">
            <a id="fig-types.html" name="fig-types.html"></a>
            <p class="title">
              <b>Figure 4.2. A Metaweb type browser</b>
            </p>
            <div class="figure-contents">
              <div>
                <img alt="A Metaweb type browser" width="100%" src="./MQL Reference Guide  Chapter 4. Metaweb Read Services_files/typebrowser.png">
              </div>
            </div>
          </div><br class="figure-break">
          <p>
            In addition to demonstrating document download with <code class="literal">Metaweb.download()</code>, this example is notable because it uses a more complicated MQL query than the other examples in this chapter and because its HTML output is more complex than previous examples. The code is well-commented, and if you've understood previous JavaScript examples, you should not have trouble following this one. One feature to note is the use of a simple helper class, named <code class="literal">DOMStream</code>, for dynamically generated output.
          </p>
          <div class="example">
            <a id="TypeBrowser.html" name="TypeBrowser.html"></a>
            <p class="title">
              <b>Example 4.13. TypeBrowser.html: a Metaweb type browser</b>
            </p>
            <div class="example-contents">
              <pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;!-- These are the modules we need --&gt;
&lt;script language="javascript" src="json2.js"&gt;&lt;/script&gt;
&lt;script language="javascript" src="metaweb.js"&gt;&lt;/script&gt;
&lt;script language="javascript"&gt; 

// This is the query we use to get information about a type.
// Note that we have to fill in the id of the type we're interested in.
var query = {
    id:null,            // The type we're asking about. Filled in below.
    type:"/type/type",  // The type of our type is /type/type :-)

    // What is the human-readable type name?
    name:null,          

    // Objects with documentation are co-typed /freebase/documented_object.
    "/freebase/documented_object/tip":null,       // Get short description
    "/freebase/documented_object/documentation":{ // And full documentation
         "optional":true,                         // ...if there is any
         "id":null                                // Return document id.
    },

    // Types are also co-typed /freebase/type_profile
    // This property gives us the status (published, private, etc.) of the type
    "/freebase/type_profile/published":null,   // Get publication status

    // What properties does this type have?
    properties:[{
        optional:true,                         // Okay if there are none
        name:null,                             // Property name for display
        key:[],                                // Property name for MQL
        expected_type: {name:null, id:null},   // Type of property value
        unique:null                            // Is it unique?
    }],

    // What other types have properties of this type?
    expected_by:[{      
        limit:25,                              // Don't return too many
        optional:true,                         // Okay if there are none
        name:null,                             // The property name
        key:[],                                // The property key
        schema: {name:null, id:null}           // What type defines it?
    }],

    // What are some instances of this type?
    instance:[{         
        limit:25,                              // Don't return too many
        optional:true,                         // Okay if there are none
        id:null,                               // So we can link to it
        name:null                              // Object name
    }]
};

// When we're first loaded, display /common/topic, or the type in the URL
window.onload = function() {
    var type = "/common/topic";                        // Assume /common/topic
    var search = window.location.search;              
    if (search &amp;&amp; search.indexOf("?t=") == 0)          // If URL specifes type
       type = decodeURIComponent(search.substring(3)); // Then use that one
    queryType(type);                                   // Display type info.
}

// Query the specified type.  Call displayType() when the results arrive
function queryType(type) {
    query.id = type;                  // Specify the type in the query above
    Metaweb.read(query,               // Issue the query
                 displayType);        // Pass result object to displayType
}

// Generate a page of information based on our query results.
function displayType(result) {
    // DOMStream is a helper class defined below.
    // We use it here to output HTML text to the placeholder element
    var out = new DOMStream("placeholder");
    out.clear()                              // Erase existing content

    // If we didn't get any results then the input was invalid
    if (!result) {
        out.write("No such type");           // Output failure message
        out.flush();                         // Flush output to placeholder
        return;                              // We're done.
    }

    // Now begin generating information about the type.
    // First, display the type id as the page title.
    out.write("&lt;h1&gt;", result.id, "&lt;/h1&gt;");   

    // If there is a short description, display it beneath the title.
    var tip = result["/freebase/documented_object/tip"]; 
    if (tip) out.write("&lt;i&gt;", tip, "&lt;/i&gt;");

    // Display the human-readable name of the type
    out.write("&lt;h2&gt;Name&lt;/h2&gt;", result.name);

    // Display publication status of the type, if available.
    var status = result["/freebase/type_profile/published"];
    if (status) out.write("&lt;h2&gt;Status&lt;/h2&gt;" + status);

    // Display type documentation, if there is any
    out.write("&lt;h2&gt;Documentation&lt;/h2&gt;");       // Section header
    var doc = result["/freebase/documented_object/documentation"];
    if (doc &amp;&amp; doc.id) {
        // If there was a document describing the type, output a placeholder
        // element for its content, and issue a request for the content to
        // be inserted into that element.
        out.write("&lt;div id='docplaceholder'&gt;&lt;i&gt;Loading...&lt;/i&gt;&lt;/div&gt;");
        Metaweb.download(doc.id, "docplaceholder"); // Asynchronous!
    }
    else out.write("No documentation available.");

    // Display a table of properties
    out.write("&lt;h2&gt;Properties&lt;/h2&gt;")
    if (result.properties.length == 0) out.write("No properties");
    else {
        out.write('&lt;table border="1"&gt;&lt;tr&gt;', 
                  '&lt;th&gt;Property Key&lt;/th&gt;',
                  '&lt;th&gt;Property Name&lt;/th&gt;',
                  '&lt;th&gt;Property Type&lt;/th&gt;&lt;/tr&gt;');

        for(var i = 0; i &lt; result.properties.length; i++) {
            out.write('&lt;tr&gt;&lt;td&gt;', result.properties[i].key.join(", "),
                      '&lt;/td&gt;&lt;td&gt;', result.properties[i].name,
                      '&lt;/td&gt;&lt;td&gt;');
            if (result.properties[i].unique) out.write("unique ");
            displayTypeLink(out, result.properties[i].expected_type.id,
                            result.properties[i].expected_type.name);
            out.write('&lt;/td&gt;&lt;/tr&gt;');
        }
        out.write("&lt;/table&gt;");
    }

    // Display the properties of other types that use this type
    out.write("&lt;h2&gt;Used by&lt;/h2&gt;")
    if (result.expected_by.length == 0)
        out.write("There are no Properties of this type.");
    else {
        out.write('&lt;table border="1"&gt;&lt;tr&gt;', 
                  '&lt;th&gt;Type&lt;/th&gt;',
                  '&lt;th&gt;Property Key&lt;/th&gt;',
                  '&lt;th&gt;Property Name&lt;/th&gt;',
                  '&lt;/tr&gt;');

        for(var i = 0; i &lt; result.expected_by.length; i++) {
            out.write('&lt;tr&gt;&lt;td&gt;');
            displayTypeLink(out, result.expected_by[i].schema.id,
                            result.expected_by[i].schema.name);
            out.write('&lt;/td&gt;&lt;td&gt;', result.expected_by[i].key.join(", "),
                      '&lt;/td&gt;&lt;td&gt;', result.expected_by[i].name,
                      '&lt;/td&gt;&lt;tr&gt;');
        }
        out.write("&lt;/table&gt;");
    }


    // Output a list of the names of instances of this type
    out.write("&lt;h2&gt;Instances&lt;/h2&gt;");
    if (result.instance.length == 0) out.write("No instances");
    else {
        for(var i = 0; i &lt; result.instance.length; i++) {
            var id = result.instance[i].id;
            var name = result.instance[i].name;
            if (!name) name = id;
            if (i != 0) out.write(", ");
            out.write("&lt;a target='_new' href='http://freebase.com/view",
                      id, "'&gt;", name, "&lt;/a&gt;");
        }
    }

    // Calling flush makes the output visible on the page
    out.flush();
}

// Output a link to a type. Use the type id as the link text, and
// make the type name available as a tooltip
function displayTypeLink(out, id, name) {
    out.write('&lt;a title="', name, '" onclick="queryType(\'', id, '\')"&gt;',
              id, '&lt;/a&gt;');
}

// This little DOMStream class writes HTML into the element we specify
function DOMStream(elt) {                     // Constructor function
    if (typeof elt == "string")               // Expects a DOM element
        elt = document.getElementById(elt);   // or element id string
    this.elt = elt;                           // Remember the element
    this.buffer = [];                         // Array to buffer output
}
DOMStream.prototype.clear = function() {      // Erase element content
    this.elt.innerHTML = "";
};
DOMStream.prototype.write = function() {      // Buffer up all arguments
    this.buffer.push.apply(this.buffer, arguments); // JavaScript voodoo
};
DOMStream.prototype.flush = function() {      // Output all text to the element
    this.elt.innerHTML += this.buffer.join(""); // Concatenate and display
    this.buffer.length = 0;                     // Empty the buffer
};
&lt;/script&gt;

&lt;style&gt;
/* Some CSS styles to make everything look good */
body {
  font-family: Arial, Helvetica, sans-serif; /* We like sans-serif */
  margin-left: .5in;                         /* Indent everything... */
}
h1, h2 {  margin-left: -.25in; }             /* ...except headings */
h2 { margin-bottom: 5px; margin-top:10px; }
/* Make tables look nice */
table { border-collapse: collapse; width: 95%;}
th { background-color: #aaa;}
td { background-color: #ddd; padding: 1px 5px 1px 5px; }

/* Our &lt;a&gt; tags don't have hrefs, so we need to style them ourselves */
a { color: #00a; }
a:hover { text-decoration:underline; cursor:pointer;}

/* Make the input field look nice */
form.inputform { 
  float:right; border: solid black 2px; background-color: #aba;
  margin: 15px 30px 0px 0px; padding: 10px;
}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;!-- A form in which the user can enter a type id --&gt;
&lt;form class='inputform' onsubmit="queryType(this.t.value); return false;"&gt;
Enter type id: &lt;input name="t"&gt;&lt;/form&gt;
&lt;!-- Generated content goes here --&gt;
&lt;div id="placeholder"&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
            </div>
          </div><br class="example-break">
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title">
                <a id="metawebpython" name="metawebpython"></a>4.8. Metaweb Services with Python
              </h2>
            </div>
          </div>
        </div>
        <p>
          As a final, advanced example of the use of the <span class="emphasis"><em>mqlread</em></span>, <span class="emphasis"><em>search</em></span>, and <span class="emphasis"><em>trans</em></span> services, <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb1.py" title="Example 4.15. metaweb.py: a Python module for Metaweb">Example 4.15</a> presents a Python module for working with Metaweb services. This module defines a <code class="literal">metaweb.Session</code> object that represents the host name of a Metaweb server, and also encapsulates a set of options (such as the <code class="literal">lang</code> option to <span class="emphasis"><em>mqlread</em></span> and the <code class="literal">maxwidth</code> option to <span class="emphasis"><em>/api/trans/image_thumb</em></span>). Each <code class="literal">Session</code> object also maintains a "cookie jar" for storing any HTTP cookies returned by Metaweb services, and uses those cookies in any subsequent requests made. (Cookies are used for authentication and caching, and are discussed in <a class="xref" href="http://mql.freebaseapps.com/ch06.html" title="Chapter 6. Metaweb Write Services">Chapter 6</a>.)
        </p>
        <p>
          One feature of <a class="xref" href="http://mql.freebaseapps.com/ch04.html#metaweb1.py" title="Example 4.15. metaweb.py: a Python module for Metaweb">Example 4.15</a> is of particular note. The <code class="literal">results()</code> method of the <code class="literal">metaweb.Session</code> class is a generator that returns the results of a MQL query one at a time, and uses the <code class="literal">cursor</code> envelope parameter to submit a MQL query as many times as necessary to retrieve all available results. You might use it in code like this:
        </p>
        <pre class="programlisting">import metaweb                                 # Use the metaweb module
freebase = metaweb.Session("api.freebase.com") # Create a Session object
albums_by_bob = [{'type':'/music/album',       # This is our MQL query
                  'artist':'Bob Dylan',
                  'name':None }]
for album in freebase.results(albums_by_bob):  # Loop through query results
    print album["name"]                        # Print album names
</pre>
        <p>
          <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.py" title="Example 4.14. Using the metaweb.py module to read, search and download">Example 4.14</a> is a Python version of <a class="xref" href="http://mql.freebaseapps.com/ch04.html#albumlist2.html" title="Example 4.10. albumlist2.html: Searching for bands">Example 4.10</a>: it lists albums by a specified band or searches for bands whose name is like a specified string. It demonstrates the metaweb.py module in more detail, showing how to use the <code class="literal">read()</code> method to invoke <span class="emphasis"><em>mqlread</em></span>, the <code class="literal">search()</code> method to invoke the <span class="emphasis"><em>search</em></span> service, and the <code class="literal">blurb()</code> method to invoke the <span class="emphasis"><em>/api/trans/blurb</em></span> service.
        </p>
        <div class="example">
          <a id="albumlist2.py" name="albumlist2.py"></a>
          <p class="title">
            <b>Example 4.14. Using the metaweb.py module to read, search and download</b>
          </p>
          <div class="example-contents">
            <pre class="programlisting">import sys            # Command-line arguments, etc.
import metaweb        # Metaweb services

band = sys.argv[1]                       # The band the user is asking about
query = { 'type': '/music/artist',       # Our MQL query in Python.
          'name': band,                  # Place the band in the query.
          'album': [{ 'name': None,
                      'release_date': None,
                      'sort': 'release_date' }]}

freebase = metaweb.Session("api.freebase.com") # Create a session object
result = freebase.read(query)                  # Submit query, get results
if result:                                     # If we got a result
    print("Albums by %s:" % result['name'])    # print the album names
    print("\n".join([album['name'] for album in result['album']]))
else:                                          # Otherwise: no result
    matches=freebase.search(band + "*",        # Start a search
                            type="/music/artist",  # Only for bands
                            limit=5)               # We only want 5
    if (len(matches) == 0):                    # If no search results
        print "Unknown band."                  # Give up.
    else:                                      # If we got some search results
        print "Did you mean one of these?:"
        for match in matches:                  # Loop through the matches
            print                      
            print match['name']                # Print the name of the match
            article = match['article']         # Get associated article
            if article:                        # If there is an article
                text,type = freebase.blurb(article['id'],  # Download a blurb
                                           maxlength=100)  # 100 chars long
                print text;                                # And print it
</pre>
          </div>
        </div><br class="example-break">
        <p>
          With those usage examples behind us, we end this chapter with the <span class="emphasis"><em>metaweb.py</em></span> code. Note that only read methods are shown here. We'll add methods for making MQL write queries and for uploading content in <a class="xref" href="http://mql.freebaseapps.com/ch06.html" title="Chapter 6. Metaweb Write Services">Chapter 6</a>.
        </p>
        <div class="example">
          <a id="metaweb1.py" name="metaweb1.py"></a>
          <p class="title">
            <b>Example 4.15. metaweb.py: a Python module for Metaweb</b>
          </p>
          <div class="example-contents">
            <pre class="programlisting">#
# metaweb.py: A python module for writing Metaweb-enabled applications
#
"""
This module defines classes for working with Metaweb databases.

  metaweb.Session: represents a connection to a database
  metaweb.ServiceError: exception raised by Session methods

Typical usage:

    import metaweb
    freebase = metaweb.Session("api.freebase.com")
    q1 = [{ 'type':'/music/album', 'artist':'Bob Dylan', 'name':None }]
    q2 = [{ 'type':'/music/album', 'artist':'Bruce Springsteen', 'name':None }]
    bob,bruce = freebase.read(q1, q2)  # Submit two queries, get two results
    for album in bob: print album['name']

    # Get query results with a generator method instead
    albums = freebase.results(q2)
    albumnames = (album['name'] for album in albums)
    for name in albumnames: print name

    # Download an image of U2
    result = freebase.read({"id":"/en/u2","/common/topic/image":[{"id":None}]})
    imageid = result["/common/topic/image"][0]["id"]
    data,type = freebase.download(imageid)
    print "%s image, %d bytes long" % (type, len(data))

"""

import urllib        # URL encoding
import simplejson    # JSON serialization and parsing
import urllib2       # URL content fetching
import cookielib     # HTTP Cookie handling

# Metaweb read services
READ = '/api/service/mqlread'    # Path to mqlread service
SEARCH = '/api/service/search'   # Path to search service
DOWNLOAD = '/api/trans/raw'      # Path to download service
BLURB = '/api/trans/blurb'       # Path to document blurb service
THUMB = '/api/trans/image_thumb' # Path to image thumbnail service

# Metaweb write services
LOGIN = '/api/account/login'     # Path to login service
WRITE = '/api/service/mqlwrite'  # Path to mqlwrite service
UPLOAD = '/api/service/upload'   # Path to upload service
TOUCH = '/api/service/touch'     # Path to touch service

# Metaweb services return this code on success
OK = '/api/status/ok'            

class Session(object):
    """
    This class represents a connection to a Metaweb database.

    It defines methods for submitting read, write and search queries to the
    database and methods for uploading and downloading binary data.  
    It encapsulates the database URL (hostname and port), read and write
    options, and maintains authentication and cache-related cookies.

    The Session class defines these methods:

      read(): issue one or more MQL queries to mqlread
      results(): a generator that performs a MQL query using a cursor
      search(): invoke the search service
      download(): retrieve content with trans/raw
      contenURL(): like download(), but just return the URL
      blurb(): retrieve a document blurb with trans/blurb
      blurbURL(): like blurb(), but just return the URL
      thumbnail(): retrieve an image thumbnail with trans/image_thumb
      thumbnailURL(): like thumbnail(), but just return the URL
      login(): establish credentials (as a cookie) for writes
      write(): invoke mqlwrite
      upload(): upload content
      touch(): get a fresh mwLastWriteTime cookie to defeat caching

    Each Session instance has these read/write attributes:

      host: the hostname (and optional port) of the Metaweb server as a string.
         The default is sandbox.freebase.com.  Every Monday, the sandbox is
         erased and it is updated with a fresh copy of data from
         www.freebase.com.  This makes it an ideal place to experiment.

      cookiejar: a cookielib.CookieJar object for storing cookies.
         If none is passed when the class is created, a
         cookielib.FileCookieJar is automatically created.  Note that cookies
         are not automatically loaded into or saved from this cookie jar,
         however. Clients that want to maintain authentication or cache state
         across invocations must save and load cookies themselves.

      options: a dict mapping option names to option values. Key/value
         pairs in this dict are used as envelope or URL parameters by
         methods that need them.  The read() method looks for a lang
         option, for example and the image_thumb looks for a maxwidth
         option. Options may be passed as named parameters to the Session() 
         constructor or to the various Session methods.
    """

    def __init__(self, host="sandbox.freebase.com", cookiejar=None, **options):
        """Session constructor method"""
        self.host = host
        self.cookiejar = cookiejar or cookielib.FileCookieJar()
        self.options = options

    def read(self, *queries, **options):
        """
        Submit one or more MQL queries to a Metaweb database, using any
        named options to override the option defaults. If there is
        a single query, return the results of that query. Otherwise, return
        an array of query results. Raises ServiceError if there were problems
        with any of the queries.
        """

        # How many queries are we handling?
        n = len(queries)

        # Gather options that apply to these queries
        opts = self._getopts("lang", "as_of_time", "escape",
                             "uniqueness_failure", **options)

        # Create an outer envelope object
        outer = {}

        # Build the inner envelope for each query and put it in the outer.
        for i in range(0, n):
            inner = {'query': queries[i]} # Inner envelope holds a query.
            inner.update(opts)            # Add envelope options.
            outer['q%d' % i] = inner      # Put inner in outer with name q(n).

        # Convert outer envelope to a string
        json = self._dumpjson(outer)

        # Encode the query string as a URL parameter and create a url
        urlparam = urllib.urlencode({'queries': json}) 
        url = 'http://%s%s?%s' % (self.host, READ, urlparam)
                
        # Fetch the URL contents, parse to a JSON object and check for errors.
        # From here on outer and inner refer to response, not query, envelopes.
        outer = self._check(self._fetch(url))

        # Extract results from the response envelope and return in an array.
        # If any individual query returned an error, raise a ServiceError.
        results = []
        for i in range(0, n):
            inner = outer["q%d" % i]         # Get inner envelope from outer
            self._check(inner)               # Check inner for errors
            results.append(inner['result'])  # Get query result from inner

        # If there was just one query, return its results.  Otherwise
        # return the array of results
        if n == 1:
            return results[0]
        else:
            return results

    def results(self, query, **options):
        """
        A generator version of the read() method. It accepts a single
        query, and yields query results one by one. It uses the envelope
        cursor parameter to return a full set of results even when more
        than one invocation of mqlread is required.
        """

        # Gather options that apply to this query
        opts = self._getopts("lang", "as_of_time", "escape", 
                             "uniqueness_failure", **options)

        # Build the query envelope
        envelope = {'query': query}
        envelope.update(opts)

        # Start with cursor set to true
        cursor = True

        # Loop until cursor is no longer true
        while cursor:
            # Use the cursor as an envelope parameter
            envelope['cursor'] = cursor

            # JSON-encode the envelope and convert it to a URL parameter
            params=urllib.urlencode({'query': self._dumpjson(envelope)}) 
                
            # Build the URL
            url = 'http://%s%s?%s' % (self.host, READ, params)

            # Fetch and parse the URL contents, raising ServiceError on errors
            response = self._check(self._fetch(url))
                
            # Get the results array and yield one result at a time
            results = response['result']
            for r in results:
                yield r

            # Get the new value of the cursor for the next iteration
            cursor = response['cursor']
            

    def search(self, query, **options):
        """
        Invoke the search service for the specified query string.  If that
        string ends with an asterisk, perform a prefix search instead of a
        straight query.  type, domain, type_strict, and other search service
        options may be specified as Session options or may be passed as named
        parameters.
        """
        opts = self._getopts("domain", "type", # Build a dict of search options
                             "type_strict",    # from these session options
                             "limit", "start",  
                             "escape", "mql_output",
                             **options)        # plus any passed to this method

        if query.endswith('*'):            # If search string ends with *
            opts["prefix"] = query[0:-1]   # then this is a prefix search
        else:                              # Otherwise...
            opts["query"] = query          # It is a regular query

        params = urllib.urlencode(opts)                    # Encode options
        url = "http://%s%s?%s" % (self.host,SEARCH,params) # Build URL
        envelope = self._fetch(url)                        # Fetch response
        self._check(envelope)                              # Check that its OK
        return envelope["result"]                          # Return result


    def download(self, id):
        """
        Return the content and type of the content object identified by id.

        Returns two values: the downloaded content (as a string of characters
        or bytes) and the type of that content (as a MIME-type string, from
        the Content-Type header returned by the Metaweb server). Raises
        ServiceError if the request fails with a useful message; otherwise
        raises urllib2.HTTPError.  See also the contentURL() method.
        """
        return self._trans(self.contentURL(id))


    def blurb(self, id, **options):
        """
        Return the content and type of a document blurb.  See blurbURL().
        """
        return self._trans(self.blurbURL(id, **options))

    def thumbnail(self, id, **options):
        """
        Return the content (as a binary string) and type of an image 
        thumbnail.  See thumbnailURL().
        """
        return self._trans(self.thumbnailURL(id, **options))


    def contentURL(self, id):
        """
        Return the /api/trans URL of the /type/content, /common/image, 
        or /common/document content identified by the id argument. 
        """
        return self._transURL(id, DOWNLOAD)

    def blurbURL(self, id, **options):
        """
        Return the /api/trans URL of a blurb of the document identified by id.

        The id must refer to a /type/content or /common/document object.
        Blurb length and paragraph breaks are controlled by maxlength and
        break_paragraph options, which can be specified in the Session object
        or passed to this method.
        """
        return self._transURL(id, BLURB, ["maxlength", "break_paragraphs"],
                              options)

    def thumbnailURL(self, id, **options):
        """
        Return the URL of a thumbnail of the image identified by id.

        The id must refer to a /type/content or /common/image object.
        Thumbnail width and height are controlled by the maxwidth and
        maxheight options, which can be specified on the Session object, or
        passed to this method.
        """
        return self._transURL(id, THUMBNAIL, ["maxwidth","maxheight"], options)


    # A utility method that returns a dict of options.  
    # It first builds a dict containing only the specified keys and their
    # values, and only if those keys exist in self.options. 
    # Then it augments this dict with the specified options.
    def _getopts(self, *keys, **local_options):
        o = {}
        for k in keys:
            if k in self.options:
                o[k] = self.options[k]
        o.update(local_options)
        return o

    # Fetch the contents of the requested HTTP URL, handling cookies from
    # the cookie jar.  Return a tuple of http status, headers and
    # response body. This is the only method in this module that performs
    # HTTP or manages cookies.  This implementation uses the urllib2 library.
    # You can subclass and override this method if you want to use a
    # different implementation with different performance characteristics.
    def _http(self, url, headers={}, body=None):
        # Store the url in case we need it later for error reporting.
        # Note that this is not safe if multiple threads use the same Session.
        self.lasturl = url;

        # Build the request.  Will use POST if a body is supplied
        request = urllib2.Request(url, body, headers)

        # Add any cookies in the cookiejar to this request
        self.cookiejar.add_cookie_header(request)

        try:
            stream = urllib2.urlopen(request) # Try to open the URL, get stream
            self.cookiejar.extract_cookies(stream, request) # Remember cookies
            headers = stream.info()
            body = stream.read()
            return (stream.code, headers, body)
        except urllib2.HTTPError, e:          # If we get an HTTP error code
            return (e.code, e.info(), e.read())  # But return values as above
       

    # Parse a string of JSON text and return an object, or raise
    # InternalServiceError if the text is unparseable.
    # This implementation uses the simplejson library.
    # You can override it in a subclass if you want to use something else.
    def _parsejson(self, s):
        try: 
            return simplejson.loads(s)
        except:
            # If we couldn't parse the response body, then we probably have an 
            # low-level HTTP error with no JSON in its response. This should
            # not happen, but if it does, we createa a fake response object
            # so that we can raise a ServiceError as we do elsewhere.
            raise InternalServiceError(self.lasturl, s)

    # Encode the object o as JSON and return the encoded text.
    # If pretty is True, use line breaks and indentation to make the output
    # more human-readable.  Override this method if you want to use an
    # implementation other than simplejson.
    def _dumpjson(self, o, pretty=False):
        if pretty:
            return simplejson.dumps(o, indent=4)
        else:
            return simplejson.dumps(o)

    # An internal utility function to fetch the contents of a Metaweb service
    # URL and parse the JSON results and return the resulting object.
    #
    # Metaweb services normally return JSON response bodies even when an HTTP 
    # error occurs, and this function parses and returns those error objects. 
    # It only raises an error on very low-level HTTP errors that do 
    # not include a JSON object as its body.
    def _fetch(self, url, headers={}, body=None):
        # Fetch the URL contents
        (status, headers, body) = self._http(url, headers, body);
        # Parse the response body as JSON, and return the resulting object.
        return self._parsejson(body)

    # This is a utility method used by download(), blurb() and thumbnail()
    # to fetch the content and type of a specified URL, performing 
    # cookie management and error handling the way the _fetch function does.
    # Unlike other Metaweb services, trans does not normally return a JSON 
    # object, so we cannot just use _fetch here.
    def _trans(self, url):
        (status,headers,body) = self._http(url)   # Fetch url content
        if (status == 200):                       # If successful
            return body,headers['content-type']   # Return content and type
        else:                                     # HTTP status other than 200
            errobj = self._parsejson(body)        # Parse the body
            raise ServiceError(url, errobj)       # And raise ServiceError

    # An internal utility function to check the status code of a Metaweb
    # response envelope and raise a ServiceError if it is not okay.
    # Returns the response if no error.
    def _check(self, response):
        code = response['code']
        if code != OK:
            raise ServiceError(self.lasturl, response)
        else:
            return response

    # This utility method returns a URL for the trans service
    def _transURL(self, id, service, option_keys=[], options={}):
        url = "http://" + self.host + service + id    # Base URL.
        opts = self._getopts(*option_keys, **options) # Get request options.
        if len(opts) &gt; 0:                             # If there are options...
            url += "?" + urllib.urlencode(opts)       # encode and add to url.
        return url


class ServiceError(Exception):
    """
    This exception class represents an error from a Metaweb service.

    When anything goes wrong with a Metaweb service, it returns a response
    object that includes an array of message objects.  When this occurs we
    wrap the entire response object in a ServiceError exception along
    with the URL that was requested.
    
    A ServiceError exception converts to a string that contains the
    requested URL (minus any URL parameters that contain the actual
    query details) plus the status code and message of the first (and
    usually only) message in the response. 

    The details attribute provides direct access to the complete response 
    object. The url attribute provides access to the full url.
    """

    # This constructor expects the URL requested and the parsed response.
    def __init__(self, url, details):
        self.url = url
        self.details = details

    # Convert to a string by printing url + the first error code and message
    def __str__(self):
        prefix = self.url.partition('?')[0]
        msg = self.details['messages'][0]
        return prefix + ": " + msg['code'] + ": " + msg['message']


class InternalServiceError(ServiceError):
    """
    A ServiceError with a fake response object. We raise one of these when
    we get an error so low-level that the HTTP response body is not a
    JSON object.  In this case we basically just report the HTTP error code.
    An exception of this type probably indicates a bug in this module.
    """
    def __init__(self, url, body):
        ServiceError.__init__(self, url, 
                              {'code':'Internal service error',
                               'messages':[{'code':'Unparseable response',
                                            'message':body}]
                               })
</pre>
          </div>
        </div><br class="example-break">
      </div>
      <div class="footnotes">
        <div class="footnote">
          <p>
            <sup>[<a class="para" href="http://mql.freebaseapps.com/ch04#id2958683" id="ftn.id2958683" name="ftn.id2958683">16</a>]</sup> Find it at <span class="emphasis"><em>http://search.cpan.org</em></span> or install it automatically by running <code class="literal"># cpan -i JSON</code>
          </p>
        </div>
        <div class="footnote">
          <p>
            <sup>[<a class="para" href="http://mql.freebaseapps.com/ch04#id2959411" id="ftn.id2959411" name="ftn.id2959411">17</a>]</sup> A Metaweb cursor is related to, but not the same as a cursor used in SQL with a relational database.
          </p>
        </div>
        <div class="footnote">
          <p>
            <sup>[<a class="para" href="http://mql.freebaseapps.com/ch04#id2959561" id="ftn.id2959561" name="ftn.id2959561">18</a>]</sup> See the discussion of the <code class="literal">as_of_time</code> envelope parameter in <a class="xref" href="http://mql.freebaseapps.com/ch04.html#asoftime" title="4.2.4.4. Making Queries in the Past">Section 4.2.4.4</a> for an explanation of how past results can be retrieved. The <code class="literal">as_of_time</code> parameter also allows you to re-retrieve the first batch of query results even though the first batch does not have a cursor value.
          </p>
        </div>
        <div class="footnote">
          <p>
            <sup>[<a class="para" href="http://mql.freebaseapps.com/ch04#id2959725" id="ftn.id2959725" name="ftn.id2959725">19</a>]</sup> September, 2008
          </p>
        </div>
        <div class="footnote">
          <p>
            <sup>[<a class="para" href="http://mql.freebaseapps.com/ch04#id2943847" id="ftn.id2943847" name="ftn.id2943847">20</a>]</sup> September, 2008
          </p>
        </div>
        <div class="footnote">
          <p>
            <sup>[<a class="para" href="http://mql.freebaseapps.com/ch04#id2963010" id="ftn.id2963010" name="ftn.id2963010">21</a>]</sup> September, 2008
          </p>
        </div>
      </div>
    </div>
    
  
</body></html>